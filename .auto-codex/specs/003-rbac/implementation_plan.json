{
  "feature": "Operations admin RBAC, config management, and Kill Switch",
  "workflow_type": "feature",
  "workflow_rationale": "Adds new operational control capabilities across admin and order services, requiring coordinated backend and integration work.",
  "phases": [
    {
      "id": "phase-1-config-storage",
      "name": "Config Storage & Versioning",
      "type": "implementation",
      "description": "Add versioned storage and rollback mechanisms for symbol/fee/risk configs in admin service.",
      "depends_on": [],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-1-1",
          "description": "Add schema/migration support for versioned configs and rollback metadata.",
          "service": "exchange-common",
          "files_to_modify": [
            "exchange-common/scripts/init-db.sql"
          ],
          "files_to_create": [
            "exchange-common/migrations/003_admin_config_versions.sql"
          ],
          "patterns_from": [
            "exchange-common/scripts/init-db.sql",
            "exchange-common/scripts/migrate.sh"
          ],
          "verification": {
            "type": "command",
            "command": "rg -n \"config_versions|config_history|risk_rules\" exchange-common/scripts/init-db.sql exchange-common/migrations/003_admin_config_versions.sql",
            "expected": "config_versions"
          },
          "status": "completed"
        },
        {
          "id": "subtask-1-2",
          "description": "Extend admin repository models/methods for versioned config CRUD and rollback targets.",
          "service": "exchange-admin",
          "files_to_modify": [
            "exchange-admin/internal/repository/admin.go",
            "exchange-admin/internal/service/repository.go"
          ],
          "files_to_create": [
            "exchange-admin/internal/repository/config.go"
          ],
          "patterns_from": [
            "exchange-admin/internal/repository/admin.go"
          ],
          "verification": {
            "type": "command",
            "command": "rg -n \"ConfigVersion|ConfigHistory|Rollback\" exchange-admin/internal/repository",
            "expected": "ConfigVersion"
          },
          "status": "completed"
        },
        {
          "id": "subtask-1-3",
          "description": "Add admin service handlers for config apply, effective-time validation, and rollback; document in OpenAPI.",
          "service": "exchange-admin",
          "files_to_modify": [
            "exchange-admin/internal/service/admin.go",
            "exchange-admin/cmd/admin/main.go",
            "exchange-admin/api/openapi.yaml"
          ],
          "files_to_create": [
            "exchange-admin/internal/service/config.go"
          ],
          "patterns_from": [
            "exchange-admin/cmd/admin/main.go",
            "exchange-admin/api/openapi.yaml"
          ],
          "verification": {
            "type": "command",
            "command": "rg -n \"/admin/configs|/admin/fees|/admin/riskRules\" exchange-admin/cmd/admin/main.go exchange-admin/api/openapi.yaml",
            "expected": "/admin"
          },
          "status": "completed"
        }
      ]
    },
    {
      "id": "phase-2-rbac-enforcement",
      "name": "RBAC Enforcement & Audit",
      "type": "implementation",
      "description": "Enforce role permissions for admin endpoints and audit both denied and sensitive actions.",
      "depends_on": [
        "phase-1-config-storage"
      ],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-2-1",
          "description": "Implement permission resolution (roles -> permissions) and helpers in admin service layer.",
          "service": "exchange-admin",
          "files_to_modify": [
            "exchange-admin/internal/repository/admin.go",
            "exchange-admin/internal/service/repository.go"
          ],
          "files_to_create": [
            "exchange-admin/internal/service/rbac.go"
          ],
          "patterns_from": [
            "exchange-admin/internal/service/admin.go",
            "exchange-admin/internal/repository/admin.go"
          ],
          "verification": {
            "type": "command",
            "command": "rg -n \"GetUserPermissions|HasPermission\" exchange-admin/internal/service",
            "expected": "HasPermission"
          },
          "status": "completed"
        },
        {
          "id": "subtask-2-2",
          "description": "Add RBAC middleware enforcing per-route permissions and write audit logs on denials.",
          "service": "exchange-admin",
          "files_to_modify": [
            "exchange-admin/cmd/admin/main.go",
            "exchange-admin/internal/service/admin.go"
          ],
          "files_to_create": [
            "exchange-admin/internal/service/permission_audit.go"
          ],
          "patterns_from": [
            "exchange-admin/cmd/admin/main.go"
          ],
          "verification": {
            "type": "manual",
            "instructions": "Review middleware wiring in exchange-admin/cmd/admin/main.go and confirm audit log creation on denied access paths."
          },
          "status": "completed"
        }
      ]
    },
    {
      "id": "phase-3-order-kill-switch",
      "name": "Order Entry Kill Switch",
      "type": "implementation",
      "description": "Ensure order entry rejects halted/cancel-only symbols with explicit error codes.",
      "depends_on": [
        "phase-1-config-storage"
      ],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-3-1",
          "description": "Return explicit kill-switch error codes in order creation for HALT/CANCEL_ONLY statuses.",
          "service": "exchange-order",
          "files_to_modify": [
            "exchange-order/internal/service/order.go",
            "exchange-order/internal/service/order_test.go"
          ],
          "files_to_create": [],
          "patterns_from": [
            "exchange-order/internal/service/order.go",
            "exchange-order/internal/service/order_test.go"
          ],
          "verification": {
            "type": "command",
            "command": "go test ./internal/service -run TestCreateOrder_SymbolNotTrading",
            "expected": "ok"
          },
          "status": "completed"
        }
      ]
    },
    {
      "id": "phase-4-integration",
      "name": "Integration & Verification",
      "type": "integration",
      "description": "Verify admin config flows, RBAC enforcement, audit logging, and kill switch behavior across services.",
      "depends_on": [
        "phase-2-rbac-enforcement",
        "phase-3-order-kill-switch"
      ],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-4-1",
          "description": "End-to-end verification across admin and order services.",
          "all_services": true,
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "e2e",
            "steps": [
              "Create a role without symbol:write and attempt POST /admin/symbols; expect permission denied and audit log entry.",
              "Apply a symbol/fee config change with an effective time inside SLA and confirm the active config changes.",
              "Rollback the last config version and confirm previous values restored.",
              "Set kill switch to halt a symbol and attempt order creation; expect explicit kill-switch error code."
            ]
          },
          "status": "pending"
        }
      ]
    }
  ],
  "summary": {
    "total_phases": 4,
    "total_subtasks": 7,
    "services_involved": [
      "exchange-admin",
      "exchange-order",
      "exchange-common"
    ],
    "parallelism": {
      "max_parallel_phases": 2,
      "parallel_groups": [
        {
          "phases": [
            "phase-2-rbac-enforcement",
            "phase-3-order-kill-switch"
          ],
          "reason": "Both depend on phase-1 and touch different services/files."
        }
      ],
      "recommended_workers": 2,
      "speedup_estimate": "1.4x faster than sequential"
    },
    "startup_command": "source auto-codex/.venv/bin/activate && python3 auto-codex/run.py --spec 003 --parallel 2"
  },
  "verification_strategy": {
    "risk_level": "high",
    "skip_validation": false,
    "test_creation_phase": "post_implementation",
    "test_types_required": [
      "unit",
      "integration",
      "e2e"
    ],
    "security_scanning_required": true,
    "staging_deployment_required": true,
    "acceptance_criteria": [
      "All existing tests pass",
      "RBAC checks deny unauthorized access and emit audit logs",
      "Config changes apply within SLA and rollback restores prior version",
      "Kill switch blocks new orders with explicit error code",
      "No security vulnerabilities detected"
    ],
    "verification_steps": [
      {
        "name": "Unit Tests (Admin)",
        "command": "go test ./...",
        "expected_outcome": "All tests pass",
        "type": "test",
        "required": true,
        "blocking": true
      },
      {
        "name": "Unit Tests (Order)",
        "command": "go test ./...",
        "expected_outcome": "All tests pass",
        "type": "test",
        "required": true,
        "blocking": true
      },
      {
        "name": "Integration Tests (Kill Switch)",
        "command": "bash scripts/e2e-test.sh",
        "expected_outcome": "Kill switch flow passes",
        "type": "test",
        "required": true,
        "blocking": false
      },
      {
        "name": "Secrets Scan",
        "command": "python3 .auto-codex/scan_secrets.py --all-files --json",
        "expected_outcome": "No secrets detected",
        "type": "security",
        "required": true,
        "blocking": true
      },
      {
        "name": "SAST Scan (Go)",
        "command": "gosec ./...",
        "expected_outcome": "No high severity issues",
        "type": "security",
        "required": true,
        "blocking": true
      }
    ],
    "reasoning": "High-risk access-control and order-entry changes require unit, integration, and e2e validation plus security scans and staging deployment."
  },
  "qa_acceptance": {
    "unit_tests": {
      "required": true,
      "commands": [
        "(cd exchange-admin && go test ./...)",
        "(cd exchange-order && go test ./...)"
      ],
      "minimum_coverage": null
    },
    "integration_tests": {
      "required": true,
      "commands": [
        "bash scripts/e2e-test.sh"
      ],
      "services_to_test": [
        "exchange-admin",
        "exchange-order"
      ]
    },
    "e2e_tests": {
      "required": true,
      "commands": [
        "bash scripts/e2e-test.sh"
      ],
      "flows": [
        "rbac-access-denied",
        "config-apply-rollback",
        "kill-switch-reject"
      ]
    },
    "browser_verification": {
      "required": false,
      "pages": []
    },
    "database_verification": {
      "required": true,
      "checks": [
        "migrations-exist",
        "migrations-applied",
        "config-history-rows-present"
      ]
    }
  },
  "qa_signoff": null
}
