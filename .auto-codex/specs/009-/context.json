{
  "task_description": "# 跨地域多活与灾备切换\n\n设计并实现跨地域多活/灾备架构，支持关键服务的主备切换与数据一致性校验，提供演练脚本。\n\n## Rationale\n极端故障时保持交易服务可用，提升企业级可靠性与客户信任。\n\n## User Stories\n- 作为平台负责人，我希望具备跨地域灾备能力，以便在重大故障时保障服务连续性。\n\n## Acceptance Criteria\n- [ ] 完成灾备演练脚本后，可在规定时间内完成核心服务切换并验证数据一致性。\n- [ ] 多活架构下关键服务健康检查与路由切换可自动化执行。\n- [ ] 演练报告记录 RTO/RPO 并满足预设目标。\n",
  "scoped_services": [
    "exchange-gateway",
    "exchange-order",
    "exchange-matching",
    "exchange-clearing",
    "exchange-user",
    "exchange-wallet",
    "exchange-marketdata"
  ],
  "files_to_modify": [
    "exchange-gateway/cmd/gateway/main.go",
    "exchange-common/pkg/routing/",
    "scripts/dr/drill.sh",
    "scripts/dr/health-monitor.sh",
    "scripts/dr/routing-switch.sh",
    "scripts/dr/consistency-check.sh"
  ],
  "files_to_reference": [
    "exchange-gateway/cmd/gateway/main.go",
    "exchange-order/cmd/order/main.go",
    "exchange-matching/internal/config/config.go",
    "scripts/e2e-test.sh",
    "scripts/test-helpers.sh",
    "交易所项目文档/交易所开发-通用总纲.md",
    "交易所项目文档/交易所项目-测试与验收.md"
  ],
  "patterns": {
    "health_check_pattern": "Services expose /health and /ready with dependencyStatus arrays and return 503 on degraded dependencies (see exchange-gateway and exchange-order main.go).",
    "proxy_pattern": "Gateway proxies requests via proxyHandler using base service URLs from config; changes should preserve header forwarding and userId query injection.",
    "config_pattern": "Service config uses exchange-common/pkg/config env loader with default ports (see exchange-matching/internal/config/config.go).",
    "script_pattern": "Operational scripts use bash with set -euo pipefail, helper functions, curl, and psql (see scripts/e2e-test.sh and scripts/test-helpers.sh)."
  },
  "existing_implementations": {
    "description": "Health endpoints already exist for core services and include dependency checks (Postgres, Redis, HTTP) plus readiness and metrics endpoints. E2E scripts include curl/psql helpers usable for drill automation.",
    "relevant_files": [
      "exchange-gateway/cmd/gateway/main.go",
      "exchange-order/cmd/order/main.go",
      "scripts/e2e-test.sh",
      "scripts/test-helpers.sh"
    ]
  },
  "created_at": "2025-12-24T04:58:08.547613",
  "updated_at": "2025-12-23T22:07:12Z"
}
