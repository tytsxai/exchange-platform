{
  "feature": "Wallet deposit/withdraw flow with reconciliation",
  "workflow_type": "feature",
  "workflow_rationale": "Adds new end-to-end wallet deposit, withdrawal approval, and reconciliation capabilities across wallet and clearing services.",
  "phases": [
    {
      "id": "phase-1-wallet-storage",
      "name": "Wallet Storage",
      "type": "implementation",
      "description": "Extend wallet persistence for address pool, approval audit trail, and deposit reconciliation records.",
      "depends_on": [],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-1-1",
          "description": "Add hot wallet address pool and reconciliation/audit tables to database schema.",
          "service": "exchange-common",
          "files_to_modify": [
            "exchange-common/scripts/init-db.sql"
          ],
          "files_to_create": [],
          "patterns_from": [
            "exchange-common/scripts/init-db.sql"
          ],
          "verification": {
            "type": "command",
            "command": "rg \"hot_wallet\" exchange-common/scripts/init-db.sql",
            "expected": "hot_wallet"
          },
          "status": "completed"
        },
        {
          "id": "subtask-1-2",
          "description": "Extend wallet repository models and interfaces for address pool, approval audit, and reconciliation records.",
          "service": "exchange-wallet",
          "files_to_modify": [
            "exchange-wallet/internal/repository/wallet.go",
            "exchange-wallet/internal/service/repository.go"
          ],
          "files_to_create": [],
          "patterns_from": [
            "exchange-wallet/internal/repository/wallet.go",
            "exchange-wallet/internal/service/repository.go"
          ],
          "verification": {
            "type": "command",
            "command": "go test ./internal/repository -run TestDepositStruct",
            "expected": "ok"
          },
          "status": "completed"
        }
      ]
    },
    {
      "id": "phase-2-wallet-workflows",
      "name": "Wallet Workflows",
      "type": "implementation",
      "description": "Implement address allocation, confirmation crediting with reconciliation records, and approval-gated withdrawals.",
      "depends_on": [
        "phase-1-wallet-storage"
      ],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-2-1",
          "description": "Use hot wallet address pool for deposit address issuance and track address lifecycle.",
          "service": "exchange-wallet",
          "files_to_modify": [
            "exchange-wallet/internal/service/wallet.go",
            "exchange-wallet/internal/service/repository.go",
            "exchange-wallet/internal/service/mock_test.go"
          ],
          "files_to_create": [],
          "patterns_from": [
            "exchange-wallet/internal/service/wallet.go",
            "exchange-wallet/internal/service/mock_test.go"
          ],
          "verification": {
            "type": "command",
            "command": "go test ./internal/service -run TestWalletService",
            "expected": "ok"
          },
          "status": "completed"
        },
        {
          "id": "subtask-2-2",
          "description": "Record reconciliation entries when confirmed deposits are credited and ensure confirmation tracking is persisted.",
          "service": "exchange-wallet",
          "files_to_modify": [
            "exchange-wallet/internal/service/wallet.go",
            "exchange-wallet/internal/service/deposit_scanner.go",
            "exchange-wallet/internal/service/wallet_service_test.go"
          ],
          "files_to_create": [],
          "patterns_from": [
            "exchange-wallet/internal/service/wallet.go",
            "exchange-wallet/internal/service/deposit_scanner.go"
          ],
          "verification": {
            "type": "command",
            "command": "go test ./internal/service -run TestWalletService_ProcessDeposit",
            "expected": "ok"
          },
          "status": "completed"
        },
        {
          "id": "subtask-2-3",
          "description": "Add withdrawal approval audit trail and expose execution status in API handlers and OpenAPI spec.",
          "service": "exchange-wallet",
          "files_to_modify": [
            "exchange-wallet/internal/service/wallet.go",
            "exchange-wallet/cmd/wallet/main.go",
            "exchange-wallet/api/openapi.yaml"
          ],
          "files_to_create": [],
          "patterns_from": [
            "exchange-wallet/cmd/wallet/main.go",
            "exchange-wallet/api/openapi.yaml"
          ],
          "verification": {
            "type": "command",
            "command": "go test ./internal/service -run TestWalletService_RejectWithdraw",
            "expected": "ok"
          },
          "status": "completed"
        }
      ]
    },
    {
      "id": "phase-3-clearing-reconciliation",
      "name": "Reconciliation Reporting",
      "type": "implementation",
      "description": "Extend reconciliation reports to detect uncredited deposits and duplicate credits.",
      "depends_on": [
        "phase-1-wallet-storage"
      ],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-3-1",
          "description": "Add reconciliation queries/report fields for uncredited deposits and duplicate credits with tests.",
          "service": "exchange-clearing",
          "files_to_modify": [
            "exchange-clearing/cmd/reconciliation/main.go",
            "exchange-clearing/cmd/reconciliation/main_test.go"
          ],
          "files_to_create": [],
          "patterns_from": [
            "exchange-clearing/cmd/reconciliation/main.go"
          ],
          "verification": {
            "type": "command",
            "command": "go test ./cmd/reconciliation -run TestRunWithDB",
            "expected": "ok"
          },
          "status": "pending"
        }
      ]
    },
    {
      "id": "phase-4-integration",
      "name": "Integration Verification",
      "type": "integration",
      "description": "Verify end-to-end deposit confirmation crediting and withdrawal approval flow.",
      "depends_on": [
        "phase-2-wallet-workflows",
        "phase-3-clearing-reconciliation"
      ],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-4-1",
          "description": "Manual end-to-end verification of deposit crediting, withdrawal approval, and reconciliation report anomalies.",
          "all_services": true,
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "e2e",
            "steps": [
              "Submit a deposit transaction and wait for required confirmations",
              "Confirm deposit credited and reconciliation record created",
              "Submit a withdrawal, approve it, and mark completion with txid",
              "Run reconciliation report and confirm uncredited/duplicate anomalies are flagged"
            ]
          },
          "status": "pending"
        }
      ]
    }
  ],
  "summary": {
    "total_phases": 4,
    "total_subtasks": 7,
    "services_involved": [
      "exchange-wallet",
      "exchange-clearing",
      "exchange-common"
    ],
    "parallelism": {
      "max_parallel_phases": 2,
      "parallel_groups": [
        {
          "phases": [
            "phase-2-wallet-workflows",
            "phase-3-clearing-reconciliation"
          ],
          "reason": "Both depend on phase-1 and touch different services/files."
        }
      ],
      "recommended_workers": 2,
      "speedup_estimate": "1.6x faster than sequential"
    },
    "startup_command": "source auto-codex/.venv/bin/activate && python3 auto-codex/run.py --spec 005 --parallel 2"
  },
  "verification_strategy": {
    "risk_level": "critical",
    "skip_validation": false,
    "test_creation_phase": "post_implementation",
    "test_types_required": [
      "unit",
      "integration",
      "e2e",
      "security"
    ],
    "security_scanning_required": true,
    "staging_deployment_required": true,
    "acceptance_criteria": [
      "All existing tests pass",
      "New deposit/withdrawal logic has unit and integration coverage",
      "Reconciliation reports flag uncredited and duplicate deposits",
      "No security vulnerabilities detected",
      "Staging deposit/withdrawal flows validated"
    ],
    "verification_steps": [
      {
        "name": "Wallet Unit Tests",
        "command": "go test ./exchange-wallet/...",
        "expected_outcome": "All wallet tests pass",
        "type": "test",
        "required": true,
        "blocking": true
      },
      {
        "name": "Clearing Unit Tests",
        "command": "go test ./exchange-clearing/...",
        "expected_outcome": "All clearing tests pass",
        "type": "test",
        "required": true,
        "blocking": true
      },
      {
        "name": "Integration Tests",
        "command": "bash exchange-common/scripts/e2e-test.sh",
        "expected_outcome": "All integration tests pass",
        "type": "test",
        "required": true,
        "blocking": true
      },
      {
        "name": "Secrets Scan",
        "command": "python3 auto-codex/scan_secrets.py --all-files --json",
        "expected_outcome": "No secrets detected",
        "type": "security",
        "required": true,
        "blocking": true
      },
      {
        "name": "Staging Verification",
        "command": "manual",
        "expected_outcome": "Deposit/withdrawal flows validated in staging",
        "type": "manual",
        "required": true,
        "blocking": true
      }
    ],
    "reasoning": "Critical financial workflows require unit, integration, and e2e coverage plus security scanning and staging validation."
  },
  "qa_acceptance": {
    "unit_tests": {
      "required": true,
      "commands": [
        "go test ./exchange-wallet/...",
        "go test ./exchange-clearing/..."
      ],
      "minimum_coverage": null
    },
    "integration_tests": {
      "required": true,
      "commands": [
        "bash exchange-common/scripts/e2e-test.sh"
      ],
      "services_to_test": [
        "exchange-wallet",
        "exchange-clearing"
      ]
    },
    "e2e_tests": {
      "required": true,
      "commands": [
        "bash exchange-common/scripts/e2e-test.sh"
      ],
      "flows": [
        "deposit-confirmation-credit",
        "withdrawal-approval",
        "reconciliation-anomaly-report"
      ]
    },
    "browser_verification": {
      "required": false,
      "pages": []
    },
    "database_verification": {
      "required": true,
      "checks": [
        "migrations-exist",
        "migrations-applied",
        "reconciliation-records-created"
      ]
    }
  },
  "qa_signoff": null
}
