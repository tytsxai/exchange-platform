{
  "feature": "Advanced order types and richer TIF strategies",
  "workflow_type": "feature",
  "workflow_rationale": "Adds new order behaviors (IOC/FOK completion rules, stop-loss/take-profit triggers, and expanded TIF exposure) across matching and order lifecycle services.",
  "phases": [
    {
      "id": "phase-1-common-contracts",
      "name": "Common Contracts",
      "type": "implementation",
      "description": "Align shared enums and error codes for advanced order types and TIF validation.",
      "depends_on": [],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-1-1",
          "description": "Extend order enums/fields to cover stop-loss/take-profit types and any new time-in-force values used by services.",
          "service": "exchange-common",
          "files_to_modify": ["exchange-common/proto/order.proto"],
          "files_to_create": [],
          "patterns_from": ["exchange-common/proto/order.proto"],
          "verification": {
            "type": "command",
            "command": "go test ./exchange-common/...",
            "expected": "ok"
          },
          "status": "completed"
        },
        {
          "id": "subtask-1-2",
          "description": "Add or refine error codes for trigger-order validation and TIF-specific rejections/expirations.",
          "service": "exchange-common",
          "files_to_modify": ["exchange-common/pkg/errors/errors.go"],
          "files_to_create": [],
          "patterns_from": ["exchange-common/pkg/errors/errors.go"],
          "verification": {
            "type": "command",
            "command": "go test ./exchange-common/...",
            "expected": "ok"
          },
          "status": "completed"
        }
      ]
    },
    {
      "id": "phase-2-matching-engine",
      "name": "Matching Engine",
      "type": "implementation",
      "description": "Enforce IOC/FOK behaviors and ensure matching logic aligns with new TIF exposure.",
      "depends_on": ["phase-1-common-contracts"],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-2-1",
          "description": "Implement FOK full-fill checks and refine IOC/FOK cancellation paths in engine/orderbook matching.",
          "service": "exchange-matching",
          "files_to_modify": [
            "exchange-matching/internal/orderbook/orderbook.go",
            "exchange-matching/internal/engine/engine.go"
          ],
          "files_to_create": [],
          "patterns_from": [
            "exchange-matching/internal/orderbook/orderbook.go",
            "exchange-matching/internal/engine/engine.go"
          ],
          "verification": {
            "type": "command",
            "command": "go test ./exchange-matching/...",
            "expected": "ok"
          },
          "status": "completed"
        },
        {
          "id": "subtask-2-2",
          "description": "Update matching handler mapping to support any new timeInForce or order type strings used by order service.",
          "service": "exchange-matching",
          "files_to_modify": ["exchange-matching/internal/handler/handler.go"],
          "files_to_create": [],
          "patterns_from": ["exchange-matching/internal/handler/handler.go"],
          "verification": {
            "type": "command",
            "command": "go test ./exchange-matching/...",
            "expected": "ok"
          },
          "status": "completed"
        }
      ]
    },
    {
      "id": "phase-3-order-lifecycle",
      "name": "Order Lifecycle",
      "type": "implementation",
      "description": "Accept stop-loss/take-profit orders, track trigger conditions, and emit market/limit orders on trigger.",
      "depends_on": ["phase-1-common-contracts"],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-3-1",
          "description": "Validate stop-loss/take-profit parameters and map order types/TIF into storage and matching payloads.",
          "service": "exchange-order",
          "files_to_modify": [
            "exchange-order/internal/service/order.go",
            "exchange-order/internal/service/validator.go",
            "exchange-order/internal/service/order_test.go"
          ],
          "files_to_create": [],
          "patterns_from": [
            "exchange-order/internal/service/order.go",
            "exchange-order/internal/service/validator.go"
          ],
          "verification": {
            "type": "command",
            "command": "go test ./exchange-order/internal/service -run TestCreateOrder",
            "expected": "ok"
          },
          "status": "completed"
        },
        {
          "id": "subtask-3-2",
          "description": "Add trigger tracking and activation logic to create market/limit orders when stop conditions are met.",
          "service": "exchange-order",
          "files_to_modify": [
            "exchange-order/internal/service/order.go",
            "exchange-order/internal/service/updater.go"
          ],
          "files_to_create": ["exchange-order/internal/service/trigger.go"],
          "patterns_from": ["exchange-order/internal/service/updater.go"],
          "verification": {
            "type": "command",
            "command": "go test ./exchange-order/internal/service -run Trigger",
            "expected": "ok"
          },
          "status": "pending"
        },
        {
          "id": "subtask-3-3",
          "description": "Persist trigger state transitions and cancellation/expiration reasons in order storage.",
          "service": "exchange-order",
          "files_to_modify": [
            "exchange-order/internal/repository/order.go",
            "exchange-order/internal/service/updater.go",
            "exchange-order/internal/service/updater_test.go"
          ],
          "files_to_create": [],
          "patterns_from": [
            "exchange-order/internal/repository/order.go",
            "exchange-order/internal/service/updater.go"
          ],
          "verification": {
            "type": "command",
            "command": "go test ./exchange-order/internal/service -run Updater",
            "expected": "ok"
          },
          "status": "pending"
        }
      ]
    },
    {
      "id": "phase-4-api-docs",
      "name": "API Documentation",
      "type": "implementation",
      "description": "Document new order types, stop fields, time-in-force values, and error codes in public API docs.",
      "depends_on": ["phase-2-matching-engine", "phase-3-order-lifecycle"],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-4-1",
          "description": "Update OpenAPI schema and examples for new order types, stopPrice, and additional timeInForce values.",
          "service": "exchange-gateway",
          "files_to_modify": ["exchange-gateway/api/openapi.yaml"],
          "files_to_create": [],
          "patterns_from": ["exchange-gateway/api/openapi.yaml"],
          "verification": {
            "type": "manual",
            "instructions": "Review OpenAPI schema for CreateOrderRequest/Order to ensure new enums and stopPrice are documented with examples."
          },
          "status": "pending"
        }
      ]
    },
    {
      "id": "phase-5-integration",
      "name": "Integration & Tests",
      "type": "integration",
      "description": "Add tests and verify end-to-end flows for IOC/FOK and trigger orders.",
      "depends_on": ["phase-2-matching-engine", "phase-3-order-lifecycle", "phase-4-api-docs"],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-5-1",
          "description": "Add or extend matching engine tests for IOC/FOK full-fill and immediate-cancel behavior.",
          "service": "exchange-matching",
          "files_to_modify": ["exchange-matching/internal/engine/engine_test.go"],
          "files_to_create": [],
          "patterns_from": ["exchange-matching/internal/engine/engine_test.go"],
          "verification": {
            "type": "command",
            "command": "go test ./exchange-matching/...",
            "expected": "ok"
          },
          "status": "pending"
        },
        {
          "id": "subtask-5-2",
          "description": "Add stop-loss/take-profit lifecycle tests covering trigger conditions and auto-generated orders.",
          "service": "exchange-order",
          "files_to_modify": [
            "exchange-order/internal/service/order_test.go",
            "exchange-order/internal/service/updater_test.go"
          ],
          "files_to_create": [],
          "patterns_from": [
            "exchange-order/internal/service/order_test.go",
            "exchange-order/internal/service/updater_test.go"
          ],
          "verification": {
            "type": "command",
            "command": "go test ./exchange-order/internal/service -run Stop",
            "expected": "ok"
          },
          "status": "pending"
        },
        {
          "id": "subtask-5-3",
          "description": "End-to-end verification of IOC/FOK placement and trigger order activation.",
          "all_services": true,
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": ["scripts/e2e-test.sh"],
          "verification": {
            "type": "e2e",
            "steps": [
              "Submit IOC order with partial liquidity and verify immediate cancel of remainder",
              "Submit FOK order without full liquidity and verify cancel",
              "Submit stop-loss/take-profit order, move price across trigger, verify new order is created and matched"
            ]
          },
          "status": "pending"
        }
      ]
    }
  ],
  "summary": {
    "total_phases": 5,
    "total_subtasks": 11,
    "services_involved": [
      "exchange-common",
      "exchange-matching",
      "exchange-order",
      "exchange-gateway"
    ],
    "parallelism": {
      "max_parallel_phases": 2,
      "parallel_groups": [
        {
          "phases": ["phase-2-matching-engine", "phase-3-order-lifecycle"],
          "reason": "Both depend only on phase-1 and touch different services/files."
        }
      ],
      "recommended_workers": 2,
      "speedup_estimate": "1.5x faster than sequential"
    },
    "startup_command": "source auto-codex/.venv/bin/activate && python3 auto-codex/run.py --spec 006 --parallel 2"
  },
  "verification_strategy": {
    "risk_level": "high",
    "skip_validation": false,
    "test_creation_phase": "post_implementation",
    "test_types_required": ["unit", "integration", "e2e"],
    "security_scanning_required": true,
    "staging_deployment_required": false,
    "acceptance_criteria": [
      "IOC/FOK orders immediately fill or cancel with explicit result",
      "Stop-loss/take-profit orders trigger into market/limit orders",
      "API docs and error codes describe new order types",
      "All existing tests pass",
      "No security vulnerabilities detected"
    ],
    "verification_steps": [
      {
        "name": "Unit Tests (matching)",
        "command": "go test ./exchange-matching/...",
        "expected_outcome": "All tests pass",
        "type": "test",
        "required": true,
        "blocking": true
      },
      {
        "name": "Unit Tests (order)",
        "command": "go test ./exchange-order/...",
        "expected_outcome": "All tests pass",
        "type": "test",
        "required": true,
        "blocking": true
      },
      {
        "name": "Integration/E2E",
        "command": "scripts/e2e-test.sh",
        "expected_outcome": "IOC/FOK and trigger flows succeed",
        "type": "test",
        "required": true,
        "blocking": true
      },
      {
        "name": "Secrets Scan",
        "command": "python3 auto-codex/scan_secrets.py --all-files --json",
        "expected_outcome": "No secrets detected",
        "type": "security",
        "required": true,
        "blocking": true
      },
      {
        "name": "SAST Scan (Go)",
        "command": "gosec ./...",
        "expected_outcome": "No high severity issues",
        "type": "security",
        "required": true,
        "blocking": true
      }
    ],
    "reasoning": "High-risk trading logic changes require unit, integration, and end-to-end coverage plus security scans."
  },
  "qa_acceptance": {
    "unit_tests": {
      "required": true,
      "commands": [
        "go test ./exchange-matching/...",
        "go test ./exchange-order/..."
      ],
      "minimum_coverage": null
    },
    "integration_tests": {
      "required": true,
      "commands": ["scripts/e2e-test.sh"],
      "services_to_test": ["exchange-order", "exchange-matching"]
    },
    "e2e_tests": {
      "required": true,
      "commands": ["scripts/e2e-test.sh"],
      "flows": ["ioc-fok-order", "stop-loss-take-profit-trigger"]
    },
    "browser_verification": {
      "required": false,
      "pages": []
    },
    "database_verification": {
      "required": false,
      "checks": []
    }
  }
}
