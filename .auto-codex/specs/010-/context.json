{
  "task_description": "# 资金账本一致性审计与对账\n\n完善清算与账本的双向校验，提供日终/实时对账、幂等校验与异常自动标记，形成可追溯审计链。\n\n## Rationale\n资金一致性是交易所核心可信基础，可降低财务风险与争议成本。\n\n## User Stories\n- 作为风控人员，我希望账本可对账且可追溯，以便快速发现并处理异常。\n\n## Acceptance Criteria\n- [ ] 给定任意交易与清算事件，账本变更可在审计日志中一键追溯到来源事件。\n- [ ] 日终对账能输出差异清单，且差异记录率为 0（在测试数据集上）。\n- [ ] 重复事件写入不会导致余额重复变更，幂等校验覆盖主要交易路径。\n",
  "scoped_services": [
    "exchange-clearing",
    "exchange-wallet",
    "exchange-common",
    "exchange-admin"
  ],
  "files_to_modify": {
    "exchange-clearing": [
      "exchange-clearing/internal/service/clearing.go",
      "exchange-clearing/internal/repository/balance.go",
      "exchange-clearing/cmd/reconciliation/main.go"
    ],
    "exchange-wallet": [
      "exchange-wallet/internal/service/wallet.go",
      "exchange-wallet/internal/repository/wallet.go",
      "exchange-wallet/internal/client/clearing.go"
    ],
    "exchange-common": [
      "exchange-common/scripts/init-db.sql"
    ],
    "exchange-admin": [
      "exchange-admin/internal/repository/admin.go"
    ]
  },
  "files_to_reference": [
    "exchange-clearing/internal/repository/balance.go",
    "exchange-clearing/internal/service/clearing.go",
    "exchange-clearing/cmd/reconciliation/main.go",
    "exchange-wallet/internal/service/wallet.go",
    "exchange-wallet/internal/repository/wallet.go",
    "exchange-admin/internal/repository/admin.go",
    "exchange-common/pkg/logger/logger.go"
  ],
  "created_at": "2025-12-24T04:57:55.932440",
  "patterns": {
    "idempotency_pattern": "BalanceRepository checks idempotency_key before ledger insert; wallet withdraw checks existing idempotency key for replay-safe handling.",
    "reconciliation_pattern": "exchange-clearing/cmd/reconciliation/main.go runs SQL diffs against ledger_entries and account_balances with optional report/history storage.",
    "audit_pattern": "exchange-admin audit_logs table + repository CreateAuditLog/ListAuditLogs pattern for append-only audit records.",
    "trace_pattern": "exchange-common/pkg/logger embeds traceID in log context via ContextWithTraceID/TraceIDFromContext."
  },
  "existing_implementations": {
    "description": "Clearing already enforces idempotency on ledger entries and ships a reconciliation CLI; wallet flows call clearing with idempotency keys; admin service has audit log schema and repository helpers; common logger supports trace IDs.",
    "relevant_files": [
      "exchange-clearing/internal/repository/balance.go",
      "exchange-clearing/internal/service/clearing.go",
      "exchange-clearing/cmd/reconciliation/main.go",
      "exchange-wallet/internal/service/wallet.go",
      "exchange-wallet/internal/repository/wallet.go",
      "exchange-admin/internal/repository/admin.go",
      "exchange-common/pkg/logger/logger.go",
      "exchange-common/scripts/init-db.sql"
    ]
  }
}
