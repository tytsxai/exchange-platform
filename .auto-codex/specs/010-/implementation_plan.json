{
  "feature": "Clearing/Wallet audit traceability and reconciliation",
  "workflow_type": "feature",
  "workflow_rationale": "Adds reconciliation, idempotency coverage, and audit linkage between clearing events and wallet ledger changes.",
  "phases": [
    {
      "id": "phase-1-discovery",
      "name": "Current Patterns Review",
      "type": "analysis",
      "description": "Identify existing audit, idempotency, and reconciliation patterns to extend.",
      "depends_on": [],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-1-1",
          "description": "Review clearing, wallet, admin audit, and common logger patterns for trace and idempotency usage.",
          "service": "exchange-clearing/exchange-wallet/exchange-admin/exchange-common",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [
            "exchange-clearing/internal/repository/balance.go",
            "exchange-clearing/internal/service/clearing.go",
            "exchange-clearing/cmd/reconciliation/main.go",
            "exchange-wallet/internal/service/wallet.go",
            "exchange-wallet/internal/repository/wallet.go",
            "exchange-admin/internal/repository/admin.go",
            "exchange-common/pkg/logger/logger.go"
          ],
          "verification": {
            "type": "note",
            "command": "",
            "expected": "Patterns and extension points documented in build-progress.txt"
          },
          "status": "completed"
        }
      ]
    },
    {
      "id": "phase-2-schema",
      "name": "Schema Extensions",
      "type": "implementation",
      "description": "Add/extend schema to persist audit linkage and reconciliation anomaly records.",
      "depends_on": ["phase-1-discovery"],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-2-1",
          "description": "Update shared schema for audit linkage and reconciliation anomaly tracking tables/fields.",
          "service": "exchange-common",
          "files_to_modify": ["exchange-common/scripts/init-db.sql"],
          "files_to_create": [],
          "patterns_from": ["exchange-common/scripts/init-db.sql", "exchange-admin/internal/repository/admin.go"],
          "verification": {
            "type": "command",
            "command": "rg \"audit|reconciliation|anomaly\" exchange-common/scripts/init-db.sql",
            "expected": "audit or reconciliation entries present"
          },
          "status": "pending"
        }
      ]
    },
    {
      "id": "phase-3-clearing",
      "name": "Clearing Audit + Reconciliation",
      "type": "implementation",
      "description": "Wire audit linkage, idempotency markers, and real-time reconciliation in clearing.",
      "depends_on": ["phase-2-schema"],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-3-1",
          "description": "Persist audit trace links and duplicate markers alongside ledger entries.",
          "service": "exchange-clearing",
          "files_to_modify": ["exchange-clearing/internal/repository/balance.go"],
          "files_to_create": ["exchange-clearing/internal/repository/audit.go"],
          "patterns_from": ["exchange-clearing/internal/repository/balance.go", "exchange-admin/internal/repository/admin.go"],
          "verification": {
            "type": "command",
            "command": "rg \"audit|trace|duplicate|idempot\" exchange-clearing/internal/repository",
            "expected": "audit or trace linkage present"
          },
          "status": "pending"
        },
        {
          "id": "subtask-3-2",
          "description": "Add real-time reconciliation check after ledger write and record anomalies on mismatch.",
          "service": "exchange-clearing",
          "files_to_modify": ["exchange-clearing/internal/service/clearing.go"],
          "files_to_create": ["exchange-clearing/internal/service/reconciliation.go"],
          "patterns_from": ["exchange-clearing/internal/service/clearing.go", "exchange-clearing/cmd/reconciliation/main.go"],
          "verification": {
            "type": "command",
            "command": "rg \"reconciliation|anomaly\" exchange-clearing/internal/service",
            "expected": "reconciliation logic present"
          },
          "status": "pending"
        },
        {
          "id": "subtask-3-3",
          "description": "Propagate trace and source event metadata into clearing ledger writes.",
          "service": "exchange-clearing",
          "files_to_modify": ["exchange-clearing/internal/service/clearing.go", "exchange-clearing/cmd/clearing/main.go"],
          "files_to_create": [],
          "patterns_from": ["exchange-common/pkg/logger/logger.go"],
          "verification": {
            "type": "command",
            "command": "rg \"trace|TraceID|source_event\" exchange-clearing/internal/service/clearing.go",
            "expected": "trace metadata present"
          },
          "status": "pending"
        },
        {
          "id": "subtask-3-4",
          "description": "Enhance end-of-day reconciliation CLI to output diff list and persist anomaly records.",
          "service": "exchange-clearing",
          "files_to_modify": ["exchange-clearing/cmd/reconciliation/main.go"],
          "files_to_create": [],
          "patterns_from": ["exchange-clearing/cmd/reconciliation/main.go"],
          "verification": {
            "type": "command",
            "command": "rg \"diff|anomaly|report\" exchange-clearing/cmd/reconciliation/main.go",
            "expected": "diff/anomaly reporting present"
          },
          "status": "pending"
        }
      ]
    },
    {
      "id": "phase-4-wallet",
      "name": "Wallet Idempotency + Trace Propagation",
      "type": "implementation",
      "description": "Ensure wallet flows propagate idempotency and audit metadata to clearing.",
      "depends_on": ["phase-2-schema"],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-4-1",
          "description": "Pass trace/audit metadata in wallet to clearing calls for deposits and withdrawals.",
          "service": "exchange-wallet",
          "files_to_modify": ["exchange-wallet/internal/service/wallet.go", "exchange-wallet/internal/client/clearing.go"],
          "files_to_create": [],
          "patterns_from": ["exchange-wallet/internal/service/wallet.go", "exchange-common/pkg/logger/logger.go"],
          "verification": {
            "type": "command",
            "command": "rg \"trace|TraceID|Idempotency\" exchange-wallet/internal/service/wallet.go exchange-wallet/internal/client/clearing.go",
            "expected": "trace or idempotency metadata present"
          },
          "status": "pending"
        }
      ]
    },
    {
      "id": "phase-5-validation",
      "name": "Integration Validation",
      "type": "integration",
      "description": "Validate reconciliation accuracy and audit traceability end-to-end.",
      "depends_on": ["phase-3-clearing", "phase-4-wallet"],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-5-1",
          "description": "Add/extend reconciliation tests covering audit trace links and zero diff results.",
          "service": "exchange-clearing",
          "files_to_modify": ["exchange-clearing/cmd/reconciliation/main_test.go"],
          "files_to_create": [],
          "patterns_from": ["exchange-clearing/cmd/reconciliation/main_test.go"],
          "verification": {
            "type": "command",
            "command": "go test ./exchange-clearing/cmd/reconciliation -run TestRunWithDB",
            "expected": "PASS"
          },
          "status": "pending"
        }
      ]
    }
  ],
  "summary": {
    "total_phases": 5,
    "total_subtasks": 8,
    "services_involved": ["exchange-common", "exchange-clearing", "exchange-wallet", "exchange-admin"],
    "parallelism": {
      "max_parallel_phases": 2,
      "parallel_groups": [
        {
          "phases": ["phase-3-clearing", "phase-4-wallet"],
          "reason": "Both depend on schema updates and touch separate services."
        }
      ],
      "recommended_workers": 2,
      "speedup_estimate": "~1.4x faster than sequential"
    }
  }
}
