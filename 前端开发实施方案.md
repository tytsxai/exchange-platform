# OpenExchange 前端开发实施方案（修订版）

> 文档状态：可执行  
> 修订日期：2026-02-16  
> 适用范围：用户端 Web + 管理后台 Web

---

## 1) 先给结论（本次直接帮你做的决策）

1. **技术栈定案为 React 路线，不再并列 Vue 备选。**  
   原因：当前项目后端契约复杂（HMAC、WS、多服务），双路线会显著放大维护成本与文档分叉。

2. **仓库策略定案为：独立前端仓库 + 仓内 Monorepo。**  
   建议仓库：`exchange-frontend`，内部管理 `apps/web`、`apps/admin`、共享 `packages/*`。

3. **私有交易接口定案为：BFF 代签名（生产必选）。**  
   后端私有接口要求 API Key HMAC 签名，**不应在浏览器长期持有 Secret**。  
   开发环境可临时支持“本地内存签名模式”，但生产禁用。

4. **MVP 优先级定案：先做“交易主链路”再做“钱包/后台扩展”。**  
   即：行情 + 下单/撤单 + 订单/资产查询优先，KYC/2FA/返佣等后置。

5. **项目目标定案：质量优先于速度。**  
   节奏可以保守，但必须通过质量门禁后再上线。

---

## 2) 技术栈（定版）

### 2.1 基础框架

- **Next.js (App Router) + TypeScript**
- **Tailwind CSS + shadcn/ui**
- **TanStack Query**（服务端状态）
- **Zustand**（UI 态/会话态）
- **react-hook-form + zod**（表单与校验）

### 2.2 交易场景必选库

- **Decimal.js**（金额、价格、手续费计算）
- **TradingView Lightweight Charts**（K 线/成交图）
- **原生 WebSocket + 自建重连管理器**
- **i18next**（国际化，默认中文可先行）

### 2.3 工程与质量

- **pnpm + Turborepo**
- **ESLint + Prettier + TypeScript strict**
- **Vitest + React Testing Library + Playwright**

### 2.4 质量优先策略（本项目强制）

1. **契约优先**：所有前端 API 类型从 OpenAPI 生成，禁止手写核心响应类型。  
2. **测试先行**：核心交易流程必须先写用例再联调实现。  
3. **可观测优先**：错误、延迟、WS 重连、关键交互都必须可监控。  
4. **灰度发布**：交易页核心变更必须支持灰度与一键回滚。  
5. **安全默认开启**：敏感信息脱敏、最小权限、依赖漏洞扫描默认启用。

---

## 3) 与当前后端契约对齐（必须遵守）

本节是对旧方案的关键修正，按当前代码与 OpenAPI 对齐：

1. **交易接口路径是 `/v1/order`（单数），不是 `/v1/orders`。**
2. **私有交易/账户接口鉴权是 HMAC API Key，不是 Bearer。**
3. **登录、API Key 管理走 Bearer；交易撮合相关走 HMAC。**
4. **交易对格式使用 `BTCUSDT`（无下划线）。**
5. **下单入参 `price/quantity` 为整型缩放值（int64 语义），前端必须做精度转换。**
6. **行情 WS 协议为：**
   - 连接：`ws://<marketdata-host>:8094/ws`
   - 入站消息：`{"op":"subscribe","channel":"market.BTCUSDT.book"}`
   - 合法频道：`market.<SYMBOL>.book|trades|ticker`
7. **私有 WS 协议为：**
   - 连接：`ws://<gateway-host>:8090/ws/private?apiKey=...&timestamp=...&nonce=...&signature=...`
   - 推送消息结构：`{channel, event?, data}`
   - 常见 channel：`order` / `trade` / `balance`

---

## 4) 前端仓库与目录设计（推荐落地）

```text
exchange-frontend/
├── apps/
│   ├── web/                       # 用户端
│   └── admin/                     # 管理后台
├── packages/
│   ├── ui/                        # 共享 UI 组件
│   ├── domain/                    # 精度转换、枚举、领域模型
│   ├── api-gateway/               # 网关 API Client（typed）
│   ├── api-admin/                 # admin API Client（typed）
│   ├── api-wallet/                # wallet API Client（typed）
│   ├── ws-client/                 # WS 管理器（重连、心跳、订阅）
│   └── config/                    # eslint/tsconfig/tailwind preset
├── scripts/
│   ├── sync-openapi.ts            # 从后端 openapi 拉取并生成类型
│   └── check-contract-drift.ts    # 契约漂移检测
└── docs/
    ├── frontend-architecture.md
    ├── auth-flow.md
    └── ws-protocol.md
```

---

## 5) 鉴权与安全架构（核心决策）

### 5.1 用户端（Web）

1. 登录后保存 **Bearer token（HttpOnly Cookie）**，用于用户态接口（如 API Key 管理）。
2. 交易/账户查询（`/v1/order`、`/v1/account` 等）通过 **BFF 路由**代签名转发。
3. BFF 在服务端维护短期 API Key 凭据缓存（加密存储 + TTL + 轮换）。
4. 浏览器端不落盘 API Secret，不进 localStorage，不打日志。

### 5.2 管理后台（Admin）

1. `exchange-admin` 需要 `Authorization + X-Admin-Token`。  
2. `X-Admin-Token` 不能暴露到浏览器，建议同样经 BFF 注入。  
3. 高风险动作（如 killSwitch）增加二次确认与审计埋点。

---

## 6) 领域实现要求（交易系统前端必须做到）

### 6.1 精度与换算（硬约束）

- 禁止金额计算使用 JS `number` 直接运算。
- 统一提供：
  - `toScaled(value, precision): string`
  - `fromScaled(value, precision): string`
  - `calcNotional(price, qty, quotePrecision): string`
- 所有展示与提交均经领域层转换，页面组件不直接处理精度细节。

### 6.2 行情与盘口

- 首次进入交易页：HTTP 拉快照（`/v1/depth` + `/v1/ticker` + `/v1/trades`）。
- 然后订阅 `market.<SYMBOL>.book/trades/ticker`。
- 检测 `seq` 不连续时，自动触发一次快照重建。
- WS 重连采用指数退避 + 订阅恢复。

### 6.3 订单与资产

- 下单前本地校验：`minQty/maxQty/qtyStep/minNotional/priceTick`。
- 提交后优先用私有 WS 回写订单状态；超时回落 HTTP 轮询。
- 撤单与下单都提供幂等 `clientOrderId`。

---

## 7) 功能范围重排（按后端现状）

### 7.1 当前可直接落地（MVP）

- 注册/登录
- API Key 创建、查看、删除
- 交易页：深度、成交、ticker、下单、撤单、当前委托、历史订单、我的成交
- 资产页：账户余额、账本流水

### 7.2 受后端能力约束，先标记为后置

- 用户 2FA 流程页面（后端接口未完整公开）
- KYC 流程（当前为预留阶段）
- 邀请返佣（未见明确契约）
- 钱包“资金划转”完整流程（需确认后端契约）
- Admin 用户封禁/KYC 审核/强制撤单（当前 admin 接口重点在符号、风控、审计、RBAC）

---

## 8) 分期计划（建议 6 周，可并行）

### P0（第 1 周）：基建与契约打通

- 初始化 Monorepo、CI、Lint、测试框架
- 建立 OpenAPI 类型生成链路
- 完成登录页与基础布局
- 搭建精度转换库与 API 错误码映射
- 产出质量门禁脚本（lint/typecheck/unit/smoke）

### P1（第 2-3 周）：交易主页面闭环

- 交易对选择、K 线、深度、逐笔成交、ticker
- 下单/撤单、当前委托、历史订单、我的成交
- 公有 WS + 私有 WS 接入与断线重连
- 完成交易主链路 E2E（下单→成交/撤单→资产更新）

### P2（第 4 周）：资产与 API Key

- 账户余额、账本流水
- API Key 管理页面
- BFF 代签名链路上线（替换开发态本地签名）
- 增加失败注入测试（超时、断网、重复提交、签名失败）

### P3（第 5 周）：管理后台最小可用

- 符号管理（增删改查）
- Kill Switch
- 审计日志浏览
- RBAC（角色列表、用户角色分配）
- 管理高风险操作二次确认与审计校验

### P4（第 6 周）：性能与稳定性收口

- 首屏优化、代码分割、缓存策略
- E2E 回归、异常场景演练（断网、超时、重连、重复提交）
- 安全检查（敏感信息泄漏、XSS、CSRF、依赖漏洞）
- 发布前压测与质量评审（Go/No-Go）

---

## 9) 质量基线（KPI + Gate）

### 9.1 量化指标（建议阈值）

| 维度 | 指标 | 目标阈值 |
| :--- | :--- | :--- |
| 类型安全 | TypeScript 编译错误 | 0 |
| 代码质量 | ESLint error | 0 |
| 单元测试 | 行情/精度/下单核心模块覆盖率 | ≥ 80% |
| E2E | 交易主链路通过率 | 100%（主分支） |
| 性能 | 交易页首屏可交互（本地基准） | ≤ 2.5s |
| 稳定性 | WS 断线重连恢复成功率 | ≥ 99% |
| 回归质量 | P0/P1 关键缺陷逃逸（上线后） | 0 个 P0，≤ 2 个 P1 |

### 9.2 上线门禁（必须全部通过）

1. `lint + typecheck + unit + smoke e2e` 全绿  
2. OpenAPI 契约漂移检查通过  
3. 安全扫描无高危（依赖/敏感信息）  
4. 关键页面性能预算不超标  
5. 具备回滚预案并已演练一次

---

## 10) 验收标准（DoD）

每个阶段交付必须同时满足：

1. **契约一致性**：与 openapi/实际接口对齐，无手写猜测字段。
2. **可回归**：核心流程具备自动化测试（至少 smoke + E2E 主链路）。
3. **可观测**：前端错误、接口耗时、WS 重连次数可统计。
4. **安全性**：API Secret 不落盘，敏感操作有确认与日志。
5. **降级能力**：WS 不可用时，页面可回退轮询并可交易。

---

## 11) 实施注意事项（避免后期返工）

1. 前端所有“交易规则”都从 `/v1/exchangeInfo` 拉取，不要硬编码。
2. 精度转换函数进入 `packages/domain`，禁止在页面散落实现。
3. 先做最小闭环（交易主链路），再扩展钱包与运营后台。
4. 每次后端接口变更必须同步：
   - `contracts/`
   - 前端 typed client
   - E2E 用例

---

## 12) 一句话总结

**这次方案从“泛化建议”改为“对齐当前后端契约的执行计划”：技术栈已定、鉴权路径已定、MVP 范围已定，可以直接开工。**
