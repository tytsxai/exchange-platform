---
title: 交易所项目-接口契约
topic: 项目文档/交易所
tags:
  - 交易所
  - API
  - WebSocket
  - 契约
summary: >
  交易所项目的接口契约草案：REST/WS 端点、鉴权签名、幂等、错误码、限流与推送频道规划。
created: 2025-12-21
updated: 2025-12-29
stage: draft
visibility: internal
owner: me
ai_include: true
source: ""
---

# 交易所项目-接口契约

> 目标：先把“端点清单 + 字段约定 + 幂等/一致性边界”写清，再补具体请求/响应示例。
> 术语口径见：[交易所项目-术语表.md](交易所项目-术语表.md)。
> 事件与消息口径见：[交易所项目-事件模型与消息规范.md](交易所项目-事件模型与消息规范.md)。

## 0 目录
- [[#1 约定与通用规范]]
- [[#2 鉴权与签名]]
- [[#3 REST API（草案）]]
- [[#4 WebSocket（草案）]]
- [[#5 错误码与可重试策略]]
- [[#6 限流与风控前置]]
- [[#7 用户与账户（核心能力预留）]]
- [[#8 KYC 与合规（核心能力预留）]]
- [[#9 钱包与出入金（核心能力预留）]]
- [[#10 运营后台 Admin（核心能力预留）]]
- [[#11 合约接口（如做）]]

---

## 1 约定与通用规范
### 1.1 字段与类型
- 命名：JSON 字段使用 `camelCase`；枚举使用全大写字符串（如 `BUY/SELL`）。
- 时间：统一 `UTC`，字段名 `timestampMs`（毫秒）。
- ID：当前实现（OpenAPI）多为 `int64`；前端/JS 必须用 `BigInt` 或按字符串处理避免精度丢失。对外接口更推荐用字符串表示（如后续切换，会在合约版本中体现）。
- 请求体大小：服务端有上限（当前默认 4MB），超限返回 `413 Request Entity Too Large`，错误码 `REQUEST_TOO_LARGE`（`message` 为 `request body too large`）。

### 1.2 金额与数量精度（强制写清）
- 推荐：金额与数量使用“最小单位整数”（如 `priceInt/qtyInt`）并在 `exchangeInfo` 返回精度（`priceTick/qtyStep`）。
- 如果使用 decimal：必须约定小数位与舍入规则（向下截断/四舍五入），并在所有端一致。

### 1.3 幂等、重试与一致性边界
- 幂等（下单）：使用 `clientOrderId`；服务端保证同一 `(userId, clientOrderId)` 重试不会重复创建订单。
- 幂等（其他写接口，如提现/转账）：使用 `X-Idempotency-Key`（若实现）。
- 写后读一致性：允许短暂延迟，但私有 WS 回报必须最终一致（订单状态/成交/资金变化）。

### 1.4 追踪
- 所有请求支持 `X-Request-Id`（可由客户端传入）；服务端贯穿日志与 WS 回报（可选）。

---

## 2 鉴权与签名
### 2.1 认证方式
- API Key + Secret（HMAC）
- 权限：`read` / `trade` / `withdraw`（如有）

### 2.2 防重放
- `timestampMs` + `nonce` + 有效窗口（例如 30s）
- 服务端拒绝：过期时间戳、重复 nonce（同 key）或窗口外请求
- 可选：API Key 级别 IP 白名单（服务端基于可信客户端 IP 校验）
  - 客户端 IP 来源：仅当上游为可信反代（loopback/内网）时采信 `X-Forwarded-For`，否则以 `RemoteAddr` 为准

### 2.3 签名算法（建议默认，可直接实现）
- 请求头：
  - `X-API-KEY`: `<apiKey>`
  - `X-API-TIMESTAMP`: `<timestampMs>`
  - `X-API-NONCE`: `<nonce>`
  - `X-API-SIGNATURE`: `<signature>`
- `signature = HMAC_SHA256(secret, canonicalString)`
- `canonicalString`（`\n` 分隔）：
  1) `timestampMs`
  2) `nonce`
  3) `method`（GET/POST/DELETE）
  4) `path`（如 `/v1/order`）
  5) `canonicalQuery`（按 key 排序，`k=v&...`，无则空串）
- `bodyHash`（可选，推荐）：`hex(sha256(body))`，当 body 非空时追加为第 6 行；body 为空则 `bodyHash` 为空且不追加该行

> 备注：服务端默认会参与 bodyHash 校验；为兼容历史客户端，可在网关开启“无 bodyHash 兼容模式”（仅当 body 为空或服务端明确允许时）。

> 备注：如果未来要兼容第三方（如 Binance 风格 query 签名），可在不破坏现有规则的前提下新增一套签名版本号。

---

## 3 REST API（草案）
### 3.1 公共接口
- `GET /v1/ping`
- `GET /v1/time`
- `GET /v1/exchangeInfo`（交易对、精度、限价规则）
- `GET /v1/ticker`（最新价/24h）
- `GET /v1/depth`（订单簿快照）
- `GET /v1/trades`（最近成交）

### 3.2 交易接口（需鉴权）
- `POST /v1/order`（下单）
- `DELETE /v1/order`（撤单，按 `orderId` 或 `clientOrderId`）
- `GET /v1/order`（单笔订单查询）
- `GET /v1/openOrders`（当前委托）
- `GET /v1/allOrders`（历史订单）
- `GET /v1/myTrades`（我的成交）

### 3.3 资产接口（需鉴权）
- `GET /v1/account`（余额/冻结/保证金，如有）
- `GET /v1/ledger`（资金流水）

### 3.4 下单接口字段（MVP 建议）
**`POST /v1/order` request**
- `symbol`：如 `BTCUSDT`
- `side`：`BUY` / `SELL`
- `type`：`LIMIT` / `MARKET`
- `timeInForce`：`GTC/IOC/FOK/POST_ONLY`（`LIMIT` 必填；`MARKET` 不需要）
- `price`：限价单必填（按精度约定：最小单位整数或 decimal 字符串）
- `quantity`：按精度约定（买/卖数量）
- `quoteOrderQty`：仅 `MARKET BUY` 可选（用“花多少钱”下单）
- `clientOrderId`：可选（强烈建议客户端传，便于幂等与对账）

**`POST /v1/order` response（建议最小字段）**
- `orderId`、`clientOrderId`
- `status`：`INIT/NEW/PARTIALLY_FILLED/FILLED/CANCELED/REJECTED/EXPIRED`
- `executedQty`、`cumulativeQuoteQty`
- `transactTimeMs`

> 订单更详细的成交/手续费明细建议通过私有 WS 推送回报，避免 REST 返回过大。

---

## 4 WebSocket（草案）
### 4.1 连接与鉴权
- 公共行情：匿名连接
- 私有频道：连接时鉴权（token 或签名），鉴权失败直接断开

当前实现：
- 公共行情：`exchange-marketdata` WS，使用 `op=subscribe/unsubscribe` + `channel`
- 私有推送：`exchange-gateway` `/ws/private`，连接 query 参数携带签名（不需要订阅消息）

### 4.1.1 消息封装（建议统一）
所有推送统一 envelope，便于客户端通用处理：
```json
{
  "channel": "market.BTCUSDT.book",
  "seq": 12345,
  "timestampMs": 1730000000000,
  "data": {}
}
```

### 4.1.2 订阅协议（示例）
```json
{"op":"subscribe","channel":"market.BTCUSDT.book"}
```
```json
{"op":"unsubscribe","channel":"market.BTCUSDT.book"}
```

### 4.1.3 私有鉴权（示例）
示例（Gateway 私有推送）：

`ws://localhost:8090/ws/private?apiKey=<apiKey>&timestamp=<timestampMs>&nonce=<nonce>&signature=<signature>`

### 4.2 公共频道（建议）
- `market.{symbol}.book`（盘口增量/快照）
- `market.{symbol}.trades`（逐笔成交）
- `market.{symbol}.kline.{interval}`（K 线）

#### `market.{symbol}.book` 数据建议
- 快照（snapshot）与增量（delta）都必须带 `seq`，并约定：
  - 增量包含 `prevSeq`（或等价字段），客户端可检测 gap
- 价格/数量使用与 REST 一致的精度约定

### 4.3 私有频道（建议）
- `user.orders`（订单回报：INIT/NEW/PARTIAL/FILLED/CANCELED/REJECTED/EXPIRED）
- `user.balances`（资产变化）
- `user.positions`（合约仓位变化，如有）

#### `user.orders` 数据建议
- 最小字段：`orderId/clientOrderId/symbol/side/type/status/origQty/executedQty/price/updateTimeMs`
- 如有成交：补充 `lastTradeId/lastFilledQty/lastFilledPrice/fee/feeAsset`

### 4.4 断线与回补
- 断线检测：心跳/seq
- 回补：按 `seq` 拉取缺失增量，或重拉快照 + seq 对齐

---

## 5 错误码与可重试策略
> 建议同时提供：HTTP 状态码 + 业务错误码（字符串或数字）+ 可重试标记。

### 5.1 统一错误响应（建议）
REST（示例）：
```json
{
  "code": "INSUFFICIENT_BALANCE",
  "message": "insufficient balance",
  "retryable": false,
  "requestId": "req_01J..."
}
```

WebSocket（示例，仍沿用 envelope）：
```json
{
  "channel": "system.error",
  "seq": 1,
  "timestampMs": 1730000000000,
  "data": {
    "code": "INVALID_SIGNATURE",
    "message": "invalid signature",
    "retryable": false,
    "requestId": "req_01J..."
  }
}
```

- `INVALID_SIGNATURE`：不可重试（修正签名/时间戳）
- `INVALID_TIMESTAMP`：可重试（校准时间后重试）
- `RATE_LIMITED`：可重试（退避 + 尊重 `Retry-After`）
- `INSUFFICIENT_BALANCE`：不可重试（调整订单或资金）
- `PRICE_OUT_OF_RANGE`：不可重试（触发价格保护/精度错误）
- `ORDER_NOT_FOUND`：通常不可重试（幂等撤单时可视为成功）
- `SYSTEM_BUSY`：可重试（必须带幂等键）

---

## 6 限流与风控前置
### 6.1 限流维度（建议默认）
- IP / 用户 / API Key / `symbol`
- 建议返回限流头：`X-RateLimit-Limit/Remaining/ResetMs`（如实现）
- 当前实现：`429` + `Retry-After: 1` + 错误码 `RATE_LIMITED`

### 6.2 风控前置（建议必须有）
- 价格保护（偏离阈值、最小下单单位、最小成交额）
- 黑白名单
- 自成交保护（是否前置取决于实现：前置可减少撮合压力）
- 频控：下单频率、撤单频率、WS 订阅数量

---

## 7 用户与账户（核心能力预留）
> 交易 API（API Key）与用户会话（Web/App）建议分离；本节列“交易所应具备”的最小能力与端点方向。

### 7.1 用户会话（Web/App）
- `POST /v1/auth/login`
- `POST /v1/auth/logout`
- `POST /v1/auth/refresh`（如用 refresh token）
- `POST /v1/auth/password/reset`（找回/重置）

### 7.2 2FA 与安全设置
- `POST /v1/security/2fa/enable`
- `POST /v1/security/2fa/disable`
- `GET /v1/security/status`（是否启用 2FA、是否绑定邮箱/手机等）

### 7.3 API Key 管理（交易 API）
- `POST /v1/apiKeys`（创建：权限、IP 白名单、备注名）
- `GET /v1/apiKeys`（列表）
- `PATCH /v1/apiKeys/{apiKeyId}`（修改权限/IP 白名单/状态）
- `DELETE /v1/apiKeys/{apiKeyId}`（删除/禁用）

> 建议：创建/修改/删除 API Key 必须二次验证（2FA）+ 审计留痕。

---

## 8 KYC 与合规（核心能力预留）
> 是否启用取决于地区与业务，但能力要预留：状态机、材料提交、审核结果、审计与导出。

- `GET /v1/kyc/status`
- `POST /v1/kyc/submit`（材料提交/更新）
- `GET /v1/kyc/requirements`（所需材料与规则）

---

## 9 钱包与出入金（核心能力预留）
> 出入金属于高风险链路：必须具备风控、审核、审计、对账与回滚策略（见 Runbook/ADR）。

### 9.1 资产与网络
- `GET /v1/assets`（支持的资产/网络、手续费、最小限额、状态）

### 9.2 充值
- `POST /v1/wallet/depositAddress`（生成/获取地址：`asset` + `network`）
- `GET /v1/wallet/deposits`（充值记录：状态/确认数/txid）

### 9.3 提现
- `POST /v1/wallet/withdraw`（提现申请：地址/数量/网络/备注；强烈建议幂等键）
- `GET /v1/wallet/withdrawals`（提现记录：状态/审核/txid）

### 9.4 地址白名单（强烈建议）
- `POST /v1/wallet/addressBook`
- `GET /v1/wallet/addressBook`
- `DELETE /v1/wallet/addressBook/{id}`

---

## 10 运营后台 Admin（核心能力预留）
> 强烈建议 admin 与用户 API 分域名/分网络，并做 RBAC + 全量审计。

### 10.1 交易与风控配置
- `POST /admin/symbols` / `PATCH /admin/symbols/{symbol}`（交易对、精度、状态）
- `POST /admin/fees` / `PATCH /admin/fees`（费率配置）
- `POST /admin/riskRules` / `PATCH /admin/riskRules/{id}`（限流/价格保护/黑白名单）
- `POST /admin/killSwitch`（全局/按 `symbol` 暂停下单、只撤单等）

### 10.2 资金与审核
- `POST /admin/withdrawals/{withdrawId}/approve`
- `POST /admin/withdrawals/{withdrawId}/reject`
- `POST /admin/balances/adjust`（人工加减款：必须双人复核 + 审计）

### 10.3 审计与查询
- `GET /admin/auditLogs`
- `GET /admin/users/{userId}`（用户状态、风险标记、KYC 状态）

---

## 11 合约接口（如做）
- 订单：`POST /v1/futures/order`、`DELETE /v1/futures/order`、`GET /v1/futures/openOrders`
- 仓位/保证金：`GET /v1/futures/account`、`GET /v1/futures/positions`
- 行情：指数/标记价 `GET /v1/futures/markPrice`、`GET /v1/futures/indexPrice`
