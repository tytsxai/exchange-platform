---
title: 交易所项目-架构总览
topic: 项目文档/交易所
tags:
  - 交易所
  - 架构
  - 系统设计
summary: >
  交易所项目的整体架构与边界：服务拆分、数据一致性策略、关键链路、扩展与降级原则；用于指导长期开发迭代。
created: 2025-12-21
updated: 2025-12-21
stage: draft
visibility: internal
owner: me
ai_include: true
source: ""
---

# 交易所项目-架构总览

> 这份文档回答“系统长什么样、边界在哪里、关键链路怎么跑、为什么这样设计”。具体接口见 [交易所项目-接口契约.md](交易所项目-接口契约.md)，数据模型见 [交易所项目-数据模型.md](交易所项目-数据模型.md)，核心功能全量清单见 [交易所项目-核心功能矩阵.md](交易所项目-核心功能矩阵.md)。

## 0 目录
- [[#1 设计目标与原则]]
- [[#2 逻辑域与服务拆分（建议）]]
- [[#3 数据一致性与写路径（资金优先）]]
- [[#4 核心链路（端到端）]]
- [[#5 扩展性（按 symbol 分片）]]
- [[#6 可靠性、降级与止血]]
- [[#7 安全、审计与合规]]
- [[#8 参考文档]]

---

## 1 设计目标与原则
### 1.1 目标
- 资金正确：不丢钱、不重记、可对账（0 容忍）
- 交易正确：撮合规则确定、状态机一致、可追溯
- 可用可扩：按 `symbol` 水平扩容，热点可治理
- 可运营：交易对/费率/风控规则可配置，且全量审计

### 1.2 原则（默认）
- 一致性优先级：资金一致性 > 订单一致性 > 行情一致性
- “实现为先、可开关”：核心能力都实现，是否对外开放用开关控制
- 单一真相来源：资金以账本为 truth（见 [ADR/ADR-002-资金账本与一致性模式.md](ADR/ADR-002-资金账本与一致性模式.md)）
- 事件驱动：撮合/清算输出事件，行情/报表等派生数据可重建

---

## 2 逻辑域与服务拆分（建议）
> 这不是唯一拆法，但建议遵循“交易核心最小化、钱包/后台隔离、事件驱动派生”。

### 2.1 接入层
- API Gateway：鉴权、限流、签名校验、灰度、路由
- WebSocket Gateway：连接管理、订阅鉴权、分发（可按频道分区）

### 2.2 用户与安全域
- Auth Service：登录/会话/2FA、安全设置
- API Key Service：API Key 管理（read/trade/withdraw）、IP 白名单、审计

### 2.3 交易域（核心）
- Order Service：下单/撤单入口、幂等、订单状态聚合（撮合不依赖 DB）
- Matching Engine：按 `symbol` 分片保序撮合（见 [ADR/ADR-001-撮合分片与保序策略.md](ADR/ADR-001-撮合分片与保序策略.md)）
- Clearing/Settlement Service：消费成交事件，更新账本/余额/订单状态（强一致写路径）
- Risk Service：价格保护、限流策略、熔断开关、自成交保护等

### 2.4 资金域
- Ledger Service：账本写入与查询（可与清算合并实现，但概念要独立）
- Balance Read Model：余额快照/缓存（可重建）

### 2.5 行情与数据域
- MarketData Service：消费撮合事件流，维护盘口/逐笔，负责 WS/REST 行情与回补（见 [ADR/ADR-003-行情链路与回补策略.md](ADR/ADR-003-行情链路与回补策略.md)）
- Kline/Aggregation：K 线聚合、存储与回补
- Reporting/OLAP（后续）：报表、风控分析、运营分析

### 2.6 钱包与出入金域（高风险，必须隔离）
- Wallet Service：充值监听、确认数、入账触发、提现审批/出款、链上对账（见 [ADR/ADR-005-出入金与钱包架构.md](ADR/ADR-005-出入金与钱包架构.md)）

### 2.7 运营后台与审计域
- Admin Service：交易对/费率/风控规则配置、提现审批、人工加减款（必须 RBAC + 审计）
- AuditLog Service：不可关闭的审计日志（见 [ADR/ADR-006-后台权限与审计模型.md](ADR/ADR-006-后台权限与审计模型.md)）

---

## 3 数据一致性与写路径（资金优先）
### 3.1 资金写路径（必须强一致）
- 下单冻结/撤单解冻/成交清算/手续费/出入金入账/提现：全部走统一清算写路径
- 每次资金变动写 `LedgerEntry`（幂等键唯一）并更新余额快照（同事务或严格保序）

### 3.2 幂等与至少一次投递
- API 层：`clientOrderId`（下单）+ 可选 `X-Idempotency-Key`（提现等）
- 事件层：允许至少一次投递，靠 `LedgerEntry.idempotencyKey` 等唯一键实现最终去重

### 3.3 派生数据可重建
- 行情、K 线、报表、搜索等尽量从事件流构建（容许短暂延迟）

---

## 4 核心链路（端到端）
### 4.1 下单到成交（现货）
1) 客户端下单 -> 网关鉴权/签名/限流
2) 前置风控（精度、最小下单、价格保护、自成交保护策略）
3) 资金预占（冻结）-> 账本/余额更新（强一致）
4) 订单进入撮合分片队列（按 `symbol`）
5) 撮合生成成交事件 `TradeCreated` + 订单状态事件
6) 清算消费成交事件：写账本、更新余额、更新订单状态
7) 私有回报（WS）推送订单/余额变化；公共行情（WS/REST）更新

### 4.2 撤单
- 撤单需要定义“生效点”：撮合前可直接撤；撮合中按队列顺序处理
- 撤单成功必须触发解冻并可审计（幂等撤单应可视为成功）

### 4.3 充值与提现（如启用）
- 充值：链上确认 -> 去重 -> 写账本入账 -> 余额更新 -> 通知与审计
- 提现：申请（幂等）-> 冻结 -> 风控/审核 -> 出款 -> 写账本结算 -> 对账

---

## 5 扩展性（按 symbol 分片）
- 分片键：`symbol`
- 撮合、行情、清算都按 `symbol` 分区消费，保证同一 `symbol` 有序
- 热点治理：限流/按 `symbol` 拆实例/暂停交易对（见 Runbook）

---

## 6 可靠性、降级与止血
- 降级优先级：资金安全 > 撮合稳定 > 行情体验
- 必备开关：全局暂停下单、只允许撤单、按 `symbol` 暂停、降低行情频率/深度
- 事故处理与回滚见：[交易所项目-运维Runbook.md](交易所项目-运维Runbook.md)

---

## 7 安全、审计与合规
- 用户侧：2FA、API Key 最小权限、IP 白名单、防重放
- 后台：RBAC、审计不可关闭、高风险双人复核（见 [ADR/ADR-006-后台权限与审计模型.md](ADR/ADR-006-后台权限与审计模型.md)）
- 钱包：出入金隔离、审批与对账（见 [ADR/ADR-005-出入金与钱包架构.md](ADR/ADR-005-出入金与钱包架构.md)）
- 合规：KYC/AML 能力预留（是否启用按地区）

---

## 8 参考文档
- 核心功能矩阵：[交易所项目-核心功能矩阵.md](交易所项目-核心功能矩阵.md)
- 项目落地文档：[交易所项目-落地文档.md](交易所项目-落地文档.md)
- 接口契约：[交易所项目-接口契约.md](交易所项目-接口契约.md)
- 数据模型：[交易所项目-数据模型.md](交易所项目-数据模型.md)
- ADR 索引：[ADR/ADR-000-索引.md](ADR/ADR-000-索引.md)
