---
title: 交易所项目-数据模型
topic: 项目文档/交易所
tags:
  - 交易所
  - 数据模型
  - 账本
  - 订单
summary: >
  交易所项目的数据模型草案：核心实体（订单、成交、账户、账本、仓位）、主键/索引、精度与一致性约束。
created: 2025-12-21
updated: 2025-12-21
stage: draft
visibility: internal
owner: me
ai_include: true
source: ""
---

# 交易所项目-数据模型

> 目标：明确“哪些表是 source of truth”，以及它们的幂等键、唯一约束与对账口径。
> 术语口径见：[交易所项目-术语表.md](交易所项目-术语表.md)。

## 0 目录
- [[#1 全局约定]]
- [[#2 核心实体]]
- [[#3 索引与查询模式]]
- [[#4 对账与审计口径]]

---

## 1 全局约定
### 1.1 时间与 ID
- 时间：`createdAtMs/updatedAtMs`（毫秒，UTC）
- ID：全局唯一（雪花/UUID 均可）。当前实现（OpenAPI）多为 `int64`；前端/JS 必须用 `BigInt` 或按字符串处理避免精度丢失。对外接口更推荐用字符串表示（如后续切换，会在合约版本中体现）。
- 幂等：订单幂等使用 `clientOrderId`，并在 DB 建唯一约束 `(userId, clientOrderId)`

### 1.2 精度与单位（必须统一）
- 推荐：金额与数量使用“最小单位整数”，并在 `SymbolConfig/ExchangeInfo` 明确：
  - `priceTick`：最小价格档位
  - `qtyStep`：最小数量步长
  - `minQty`、`minNotional`
- 若使用 decimal：必须统一小数位与舍入策略（建议“向下截断”，避免透支）

### 1.3 状态机与可追溯性
- 订单/成交/资金都必须能追溯状态变化（至少能回答：谁在什么时候做了什么导致余额变化）。
- 资金变动必须落到账本（见 [ADR/ADR-002-资金账本与一致性模式.md](ADR/ADR-002-资金账本与一致性模式.md)），禁止“直接改余额不留痕”。

### 1.4 关键不变式（invariants）
- 任意时点：`available >= 0 && frozen >= 0`
- 任意时点：余额快照与账本聚合一致（抽样 + 夜间全量）

---

## 2 核心实体
### 2.1 Order（订单）
> 订单簿不依赖数据库，但订单“结果”必须可查询、可审计。

- 主键：`orderId`
- 幂等唯一：`(userId, clientOrderId)`（可空；空则不参与唯一）
- 建议字段：
  - `userId, symbol, side, type, timeInForce`
  - `price, origQty, executedQty`
  - `status`：`NEW/PARTIALLY_FILLED/FILLED/CANCELED/REJECTED/EXPIRED`
  - `createTimeMs, updateTimeMs`
  - `rejectReason, cancelReason`（如有）
- 关联：
  - 成交通过 `Trade(makerOrderId/takerOrderId)` 关联
  - 资金通过 `LedgerEntry(refType, refId)` 关联（建议 `refType=ORDER/TRADE`）

### 2.2 Trade（成交）
- 主键：`tradeId`
- 建议字段：
  - `symbol, price, qty, quoteQty`
  - `makerOrderId, takerOrderId`
  - `makerUserId, takerUserId`（可选，但对审计/回放很有用）
  - `makerFee, takerFee, feeAsset`（或分别记录两侧 fee）
  - `timestampMs`
- 衍生：对用户维度的成交回报可从事件流/视图构建

### 2.3 AccountBalance（账户余额，现货）
- 主键：`(userId, asset)`
- 字段：`available, frozen, version, updatedAtMs`
- 说明：
  - 若采用账本为 truth（推荐），余额表是“可重建快照/读模型”
  - 仍建议在清算写路径中同步更新余额快照（提升查询性能）
  - 并发控制：使用 `version` 乐观锁或行锁，保证同一 `userId+asset` 串行更新

### 2.4 LedgerEntry（账本流水，建议为 truth）
- 主键：`ledgerId`
- 唯一/幂等：`idempotencyKey`（强制唯一，用于抵抗重复投递）
- 建议字段（便于审计与对账）：
  - `userId, asset`
  - `availableDelta, frozenDelta`
  - `availableAfter, frozenAfter`
  - `reason`（枚举，如 `ORDER_FREEZE/ORDER_UNFREEZE/TRADE_SETTLE/FEE/ADJUST/DEPOSIT/WITHDRAW`）
  - `refType, refId`（如 `ORDER:{orderId}` / `TRADE:{tradeId}`）
  - `createdAtMs`
- 约束：同一 `userId+asset` 的写入需保序（分区串行或事务）
  - `idempotencyKey` 推荐可读格式（示例）：`ledger:{reason}:{refType}:{refId}:{userId}:{asset}`（与事件模型约定保持一致）

### 2.5 Position（仓位，如做合约/杠杆）
- 主键：`(userId, symbol, positionSide)`
- 字段：`qty, entryPrice, margin, unrealizedPnl, leverage`
- 说明：与标记价/指数价强相关，需明确计算口径

### 2.6 SymbolConfig（交易对配置，建议）
> 用于 `exchangeInfo`，也是很多风控与精度规则的来源。

- 主键：`symbol`
- 字段：`baseAsset, quoteAsset, priceTick, qtyStep, minQty, minNotional`
- 可选：`status`（`TRADING/HALT`）、`makerFeeRate/takerFeeRate`、价格保护阈值

### 2.7 User（用户）
- 主键：`userId`
- 建议字段：`email/phone（任选其一或都支持）`、`passwordHash`、`status`（`ACTIVE/FROZEN`）、`createdAtMs`
- 说明：资金/交易等敏感操作必须依赖用户状态与风控标记

### 2.8 UserSecurity（用户安全设置，建议）
- 主键：`userId`
- 字段：`totpEnabled`、`antiPhishingCode`（可选）、`withdrawWhitelistEnabled`（可选）、`updatedAtMs`
- 说明：提现/改密/改 API Key 等操作的二次验证策略建议在这里落地

### 2.9 ApiKey（API Key）
- 主键：`apiKeyId`
- 唯一：`apiKey`（公开部分）唯一；secret 只存 hash（或加密存储，按安全策略）
- 字段：`userId, apiKey, secretHash/encryptedSecret, permissions, ipWhitelist, status, createdAtMs, updatedAtMs`
- 说明：权限最小化；创建/修改/删除必须审计

### 2.10 KycProfile（KYC，能力预留）
- 主键：`userId`
- 字段：`status`（`NOT_STARTED/IN_REVIEW/APPROVED/REJECTED`）、`level`（可选）、`submittedAtMs, reviewedAtMs`
- 说明：是否启用由地区决定，但状态机与审计必须预留

### 2.11 Asset / Network（资产与链网络，建议）
> 用于出入金与手续费配置，也是很多风控规则的来源。

- `Asset(asset)`：`asset, precision, status`
- `Network(asset, network)`：`network, depositEnabled, withdrawEnabled, minWithdraw, withdrawFee, confirmationsRequired, status`

### 2.12 DepositAddress（充值地址，能力预留）
- 主键：`(userId, asset, network)`
- 字段：`address, tag/memo（可选）, createdAtMs, updatedAtMs`
- 说明：地址复用/一人一址/多址策略属于关键决策（建议 ADR）

### 2.13 Deposit（充值记录，能力预留）
- 主键：`depositId`
- 唯一：`(asset, network, txid, vout/index)`（避免重复入账）
- 字段：`userId, asset, network, amount, txid, confirmations, status, creditedAtMs`
- 说明：入账必须走账本：`LedgerEntry(reason=DEPOSIT, refId=depositId)`

### 2.14 Withdrawal（提现记录，能力预留）
- 主键：`withdrawId`
- 唯一：`idempotencyKey`（强烈建议唯一，抵抗重复提交）
- 字段：`userId, asset, network, amount, fee, address, tag/memo, status, requestedAtMs, approvedAtMs, sentAtMs, txid`
- 说明：
  - 申请时冻结资金（或预扣），出款后记账
  - 出款链路必须可审计（审批/拒绝/打款人/时间）

### 2.15 AddressBookEntry（地址白名单，建议）
- 主键：`addressBookId`
- 字段：`userId, asset, network, address, tag/memo, label, createdAtMs`

### 2.16 AdminAuditLog（后台审计日志，建议）
- 主键：`auditId`
- 字段：`actorUserId, action, targetType, targetId, beforeJson, afterJson, ip, createdAtMs`
- 说明：配置/资金/权限变更必须留痕，便于追责与复盘

### 2.17 FeeConfig / FeeTier（费率体系，建议）
- `FeeTier(tierId)`：`makerRate, takerRate, conditionsJson`
- `UserFeeTier(userId)`：`tierId, updatedAtMs`

---

## 3 索引与查询模式
### 3.1 订单
- `Order(userId, status, updateTimeMs)`：用于“当前委托/订单历史”
- `Order(userId, symbol, updateTimeMs)`：按交易对过滤
- `Order(symbol, updateTimeMs)`：运营/监控查询（可选）

### 3.2 成交
- `Trade(symbol, timestampMs)`：市场逐笔/回放
- `Trade(makerOrderId)`、`Trade(takerOrderId)`：订单审计
- `Trade(makerUserId, timestampMs)`、`Trade(takerUserId, timestampMs)`：用户交易历史（可选）

### 3.3 账本
- `LedgerEntry(userId, asset, createdAtMs)`：用户资金流水
- `LedgerEntry(idempotencyKey)`：幂等去重
- `LedgerEntry(refType, refId)`：按订单/成交追溯资金变动

### 3.4 用户与权限
- `ApiKey(userId, status, createdAtMs)`
- `User(email/phone)`（唯一索引）
- `AdminAuditLog(actorUserId, createdAtMs)`

### 3.5 出入金（如启用）
- `Deposit(userId, createdAtMs)`、`Deposit(asset, txid)`
- `Withdrawal(userId, requestedAtMs)`、`Withdrawal(status, requestedAtMs)`
- `DepositAddress(userId, asset, network)`

---

## 4 对账与审计口径
### 4.1 资金不丢（核心）
- 口径：对任意 `(userId, asset)`，
  - `AccountBalance.available + AccountBalance.frozen == sum(LedgerEntry.availableDelta + LedgerEntry.frozenDelta)` 的累积结果（按实现定义）
- 要求：对账异常 0 容忍（出现即 P0，参见 Runbook）

### 4.2 订单一致
- `Order.executedQty == sum(Trade.qty where orderId in [makerOrderId,takerOrderId])`
- 订单状态机与成交数量一致（避免“已成交但状态未更新/反之”）

### 4.3 可追溯
- 任意余额变化都能追溯到 `LedgerEntry.refType/refId`，并进一步追溯到 `Order/Trade/Deposit/Withdraw` 等源对象

### 4.4 链上对账（如启用出入金）
- 充值：链上确认的入账总和 == 账本 `DEPOSIT` 聚合（按资产/网络/时间窗）
- 提现：链上出款总和（含手续费）与账本 `WITHDRAW` 聚合一致；异常必须可定位到具体 `withdrawId/txid`

### 4.5 后台审计
- 所有“配置/资金/权限”变更必须在 `AdminAuditLog` 有记录，并能回放变更前后差异
