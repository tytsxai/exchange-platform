---
title: 交易所项目-事件模型与消息规范
topic: 项目文档/交易所
tags:
  - 交易所
  - 事件驱动
  - 消息规范
  - WebSocket
summary: >
  交易所项目的事件与消息规范：事件类型、统一 envelope、Topic/分区键、版本策略、幂等与回放；用于撮合/清算/行情/钱包/通知等模块协作。
created: 2025-12-21
updated: 2025-12-21
stage: draft
visibility: internal
owner: me
ai_include: true
source: ""
---

# 交易所项目-事件模型与消息规范

> 目标：让所有模块“说同一种话”。撮合/清算/钱包/行情/通知等通过事件协作，避免口径不一致导致资金与状态错误。
> 术语口径见：[交易所项目-术语表.md](交易所项目-术语表.md)。

## 0 目录
- [[#1 统一 Envelope（所有事件通用）]]
- [[#2 Topic 与分区键（保序与扩展）]]
- [[#3 事件版本与兼容策略]]
- [[#4 核心事件清单（P0）]]
- [[#5 行情消息（WS）与 seq]]
- [[#6 幂等、重试与回放]]

---

## 1 统一 Envelope（所有事件通用）
> 推荐所有事件都包一层 envelope，便于追踪、幂等与版本演进。

```json
{
  "eventId": "evt_01J...",
  "eventType": "TradeCreated",
  "version": 1,
  "occurredAtMs": 1730000000000,
  "producer": "matching-engine",
  "partitionKey": "BTCUSDT",
  "traceId": "req_...",
  "data": {}
}
```

字段说明：
- `eventId`：全局唯一（用于去重与审计）
- `eventType + version`：决定 `data` 的 schema
- `occurredAtMs`：事件发生时间（UTC ms）
- `producer`：产出服务（便于排障）
- `partitionKey`：分区键（决定保序与扩展）
- `traceId`：贯穿链路（可选，但强烈建议）

---

## 2 Topic 与分区键（保序与扩展）
> 目标：同一个“需要有序”的域必须落到同一分区。

### 2.1 分区键建议
- 交易/撮合/行情：`symbol`
- 资金/通知：`userId`（或 `userId:asset`）
- 钱包/出入金：`userId`（并额外带 `asset/network` 字段）

### 2.2 Topic 规划（建议最小集）
- `order.events`（key=`symbol`）
- `trade.events`（key=`symbol`）
- `ledger.events`（key=`userId` 或 `userId:asset`）
- `wallet.events`（key=`userId`）
- `admin.events`（key=`actorUserId` 或 `resourceId`）
- `marketdata.events`（key=`symbol`，用于内部聚合；对外 WS 另算）

> 采用 Outbox 保证写库与发事件一致（见 [ADR/ADR-007-事件总线与Outbox一致性.md](ADR/ADR-007-事件总线与Outbox一致性.md)）。

---

## 3 事件版本与兼容策略
- 只做向后兼容变更：新增字段、扩大枚举（谨慎）
- 破坏性变更：提升 `version`，并保持旧版一段时间（灰度迁移）
- 事件字段必须写清“是否可选/默认值/单位/精度”

---

## 4 核心事件清单（P0）
> P0 事件必须具备：可追溯、可幂等、可回放（至少能重建派生数据）。

### 4.1 订单事件（Order）
- `OrderAccepted`：订单通过校验并入队
- `OrderRejected`：订单拒绝（带 `reason`）
- `OrderCanceled`：订单取消成功（带 `cancelReason`）
- `OrderUpdated`：订单状态更新（如部分成交）

#### 4.1.1 订单状态机（建议最小集）
- `NEW -> PARTIALLY_FILLED -> FILLED`
- `NEW/PARTIALLY_FILLED -> CANCELED`
- `NEW -> REJECTED`
- `NEW -> EXPIRED`（仅在实现 `IOC/FOK` 或订单超时策略时出现）

建议约定：
- 撮合侧输出事件按 `symbol` 保序；消费者不得对同一 `symbol` 并发乱序处理。
- `OrderUpdated` 必须包含“变更后的全量状态”（至少包含 `executedQty/status/updateTimeMs`），避免消费者依赖增量计算。

**Order 关键字段建议**
- `orderId, clientOrderId, userId, symbol, side, type, timeInForce`
- `price, origQty, executedQty, status, updateTimeMs`

### 4.2 成交事件（Trade）
- `TradeCreated`：撮合产生成交（必须严格有序，按 `symbol`）

**Trade 关键字段建议**
- `tradeId, symbol, price, qty, quoteQty, timestampMs`
- `makerOrderId, takerOrderId, makerUserId, takerUserId`
- `makerFee, takerFee, feeAsset`

### 4.3 资金事件（Ledger/Balance）
- `LedgerEntryCreated`：账本流水新增（建议由清算服务产出，或由账本服务产出）
- `BalanceChanged`：余额变化（可选；可由账本事件派生）

**LedgerEntry 关键字段建议**
- `ledgerId, idempotencyKey, userId, asset`
- `availableDelta, frozenDelta, availableAfter, frozenAfter`
- `reason, refType, refId, createdAtMs`

### 4.4 钱包事件（Deposit/Withdraw，如启用）
- `DepositDetected`：检测到链上入账（未确认）
- `DepositConfirmed`：确认数达到阈值
- `DepositCredited`：完成站内入账（写账本成功）
- `WithdrawRequested`：提现申请创建（冻结成功）
- `WithdrawApproved` / `WithdrawRejected`：审核结果（如有）
- `WithdrawSent`：出款已广播（有 `txid`）
- `WithdrawCompleted`：确认完成（可选，按链/业务）

### 4.5 后台与配置事件（Admin/Config）
- `SymbolConfigUpdated`：交易对/精度/状态变更
- `FeeConfigUpdated`：费率变更
- `KillSwitchChanged`：开关变更（全局/按 `symbol`）
- `RiskRuleUpdated`：风控规则变更
- `AdminAuditLogged`：审计写入（可选，通常审计在 DB 即可）

---

## 5 行情消息（WS）与 seq
> 对外 WS 行情建议使用“快照 + 增量 + seq”模型，客户端能检测 gap 并恢复。

### 5.1 WS Envelope（对外）
```json
{
  "channel": "market.BTCUSDT.book",
  "seq": 12345,
  "timestampMs": 1730000000000,
  "data": {}
}
```

### 5.2 `market.{symbol}.book`
- `BookSnapshot`：包含 `snapshotSeq`
- `BookDelta`：包含 `seq` 与 `prevSeq`

客户端规则：
- 若 `prevSeq != lastSeq`：判定丢包 -> 立即重拉快照 -> 用快照 `snapshotSeq` 重置

---

## 6 幂等、重试与回放
### 6.1 幂等（必须）
- 资金：以 `LedgerEntry.idempotencyKey` 唯一约束实现最终去重（见 [ADR/ADR-002-资金账本与一致性模式.md](ADR/ADR-002-资金账本与一致性模式.md)）
- 钱包：充值以 `(asset, network, txid, index)` 去重；提现以 `idempotencyKey` 去重

#### 6.1.1 幂等键建议（便于统一与排障）
- 账本（清算/冻结/解冻/手续费等）：建议 `ledger:{reason}:{refType}:{refId}:{userId}:{asset}`（同一业务动作同一幂等键）
- 提现申请：建议 `withdraw:{userId}:{asset}:{clientRequestId}`（或直接复用 `X-Idempotency-Key`）
- 事件去重：事件层 `eventId` 全局唯一；消费端可用 “已处理事件表” 或 “业务唯一键” 双保险

### 6.2 重试（允许至少一次）
- 事件投递允许重复；消费端必须“可重复执行而不改变最终结果”

### 6.3 回放（可选但强烈建议预留）
- 行情/报表可通过重放 `TradeCreated/BookDelta` 重建
- 对资金链路：账本天然可审计；必要时可通过重放清算事件校验一致性
