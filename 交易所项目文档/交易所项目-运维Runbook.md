---
title: 交易所项目-运维Runbook
topic: 项目文档/交易所
tags:
  - 交易所
  - 运维
  - 监控
  - 可靠性
summary: >
  交易所项目的运维与应急手册：SLO、关键指标、告警、降级开关、回滚与事故处理流程。
created: 2025-12-21
updated: 2025-12-21
stage: draft
visibility: internal
owner: me
ai_include: true
source: ""
---

# 交易所项目-运维Runbook

## 0 目录
- [[#1 SLO 与告警目标]]
- [[#2 关键指标（必须监控）]]
- [[#3 降级与紧急开关]]
- [[#4 事故处理流程]]
- [[#5 回滚与数据修复]]
- [[#0.1 上线前配置校验]]

---

## 0.1 上线前配置校验
- `INTERNAL_TOKEN` 必须配置且非默认值（所有内部调用需一致）
- `AUTH_TOKEN_SECRET` 必须配置（长度不少于 32 字符），`AUTH_TOKEN_TTL` 设置合理过期
- `ADMIN_TOKEN` 必须配置（保护后台与钱包管理接口；请求需携带 `X-Admin-Token`）
- `EVENT_REPLAY_COUNT` 建议设置（行情重启回放条数，默认 1000，可按 TPS 调整）
- `DB_SSL_MODE=require`（生产）+ 合理的连接池参数（`DB_MAX_OPEN_CONNS` 等）

## 1 SLO 与告警目标
- 可用性：`99.9%`
- 撮合延迟：p99 < 10ms（按 `symbol` 单独统计）
- WS 推送延迟：p99 < 50ms
- 资金一致性：对账异常 `0` 容忍（出现即 P0）

### 1.1 告警分级建议
- P0：资金对账异常、负余额（理论应为 0）、签名校验绕过、安全事件
- P1：撮合不可用/大面积拒单、清算积压导致订单回报严重延迟
- P2：行情延迟/断线率升高、单 `symbol` 异常波动/熔断频繁

---

## 2 关键指标（必须监控）
- 撮合：队列长度、撮合耗时、拒单率、每 `symbol` TPS、热点 `symbol` 占比
- 清算：入队/出队延迟、幂等去重命中率、失败重试数
- 资金：对账异常数、负余额（应为 0）、账本写入失败数
- 行情：推送延迟、断线率、回补次数
- 钱包（如启用）：充值确认滞后、入账队列、提现待审/待出款队列、出款失败率、链上对账差异
- 后台（必须）：高风险操作次数、审计写入失败数、权限校验失败数（异常增长告警）

### 2.1 最小仪表盘（建议）
- 交易核心总览：撮合 p99、清算 lag、拒单率、WS 推送 p99
- 热点 `symbol` 看板：TPS、队列长度、熔断/暂停次数
- 资金安全看板：对账异常、负余额、账本写入错误、幂等冲突数
- 风控看板：价格保护命中、限流命中、自成交保护命中

---

## 3 降级与紧急开关
- 全局：暂停下单 / 只允许撤单 / 只读查询 / 停止提现（如有）
- 按 `symbol`：暂停交易 / 提高限流 / 强制只读行情
- 风控：提高价格保护阈值、禁用高风险订单类型（若支持）

### 3.1 开关优先级（建议）
1. 资金安全优先：一旦发现资金异常，优先“暂停下单/仅撤单”，必要时按用户或资产冻结
2. 撮合保护：撮合/清算积压时，按 `symbol` 暂停或限流热点
3. 体验降级：降低行情推送频率/深度，保留逐笔成交

---

## 4 事故处理流程
1) 定级：P0（资金一致性/安全）> P1（撮合不可用）> P2（行情延迟）…
2) 止血：开关降级（先只撤单/暂停下单）
3) 定位：按 `symbol` 与 trace id 定位瓶颈
4) 恢复：灰度恢复下单 -> 恢复行情 -> 恢复全量功能
5) 复盘：补 ADR/补验收用例/更新监控与开关

### 4.1 常见事故 Runbook（最小版）
#### A) 撮合延迟飙升/队列积压
- 现象：撮合队列长度持续增长、订单回报延迟、拒单率上升
- 立即动作：
  1) 对热点 `symbol` 限流或暂停（先保资金与稳定性）
  2) 若积压影响全局：切到“只撤单/暂停下单”
- 定位要点：CPU/GC/锁竞争、单 `symbol` 热点、订单簿异常增长
- 恢复：逐步放开限流，优先恢复低风险 `symbol`

#### B) 清算积压/重复失败
- 现象：成交已生成但余额/订单状态更新慢；consumer lag 增长
- 立即动作：
  1) 降低撮合入口（限流/暂停热点）避免雪崩
  2) 检查幂等冲突/DB 锁等待（见 [ADR/ADR-002-资金账本与一致性模式.md](ADR/ADR-002-资金账本与一致性模式.md)）
- 恢复：确认“幂等生效 + 事务提交正常”后再恢复入口

#### C) 资金对账异常/负余额（P0）
- 现象：对账作业报警、出现负余额、账本与余额快照不一致
- 立即动作：
  1) 全局暂停下单（至少暂停相关资产/用户）
  2) 保留撤单通道（释放冻结，降低风险扩散）
  3) 固化证据：锁定当时段日志/事件流 offset/DB 快照
- 定位要点：重复清算、撤单/成交并发竞态、精度/舍入导致透支
- 恢复：以账本为准做修复（见第 5 章），灰度恢复下单

#### D) 钱包异常（充值不入账/提现出款失败）（如启用）
- 现象：充值长时间不入账、提现队列积压、出款失败率升高、链上对账差异扩大
- 立即动作：
  1) 关闭出入金开关（先止血，避免扩大损失）
  2) 保留站内交易与撤单；必要时提高风控阈值
  3) 固化证据：节点状态/第三方回执、队列 offset、相关日志
- 定位要点：节点同步高度、确认数策略、去重/幂等冲突、审批流阻塞、签名/出款器异常
- 恢复：先恢复充值监听与入账对账，再灰度恢复提现（先小额/白名单）

#### E) 撮合重启/发布导致挂单丢失风险（P0）
- 现象：撮合进程重启后，内存订单簿为空，历史挂单无法继续撮合
- 立即动作：
  1) 发布前先“全局只撤单/暂停下单”（Kill Switch）
  2) 等待撮合消费队列清空，确认无积压
  3) 发布后主动撤销所有未成交订单并解冻资金
- 恢复：确认订单与资金一致后，再恢复下单入口

---

## 5 回滚与数据修复
- 回滚：服务版本回滚、配置回滚、规则回滚（分别列出路径）
### 5.1 数据修复原则（建议默认）
- 只允许通过“追加账本（补记/冲正）”修复，禁止直接改余额不留痕（与 [ADR/ADR-002-资金账本与一致性模式.md](ADR/ADR-002-资金账本与一致性模式.md) 对齐）。
- 修复前先止血（暂停下单/冻结相关资产），修复后必须全量对账并留存审计记录。

### 5.2 常见修复类型（示例）
- 重复记账：追加一笔“冲正”账本流水（带 refId 指向原错误流水）
- 少记账：追加一笔“补记”账本流水（带 refId 指向原成交/订单）

### 5.3 备份与恢复（最小流程）
- PostgreSQL 备份：`exchange-common/scripts/backup-db.sh`（依赖 `DB_URL`，产出 `.dump` 文件）
- PostgreSQL 恢复：`exchange-common/scripts/restore-db.sh <backup-file>`（恢复后需全量对账）
- Redis 备份：`exchange-common/scripts/backup-redis.sh`（依赖 `REDIS_ADDR`，产出 `.rdb` 文件）
- 数据库迁移：`exchange-common/scripts/migrate.sh`（执行 `init-db.sql` 并记录 `schema_migrations`）
- 频率建议：数据库每日全量 + 关键变更前手动备份；恢复后必须跑健康检查与资金对账
