---
title: 交易所项目-测试与验收
topic: 项目文档/交易所
tags:
  - 交易所
  - 测试
  - 验收
  - 压测
summary: >
  交易所项目的测试策略与验收清单：撮合正确性、资金一致性、性能压测、故障演练与上线验收口径。
created: 2025-12-21
updated: 2025-12-21
stage: draft
visibility: internal
owner: me
ai_include: true
source: ""
---

# 交易所项目-测试与验收

## 0 目录
- [[#1 测试分层]]
- [[#2 核心验收清单]]
- [[#3 压测与容量]]
- [[#4 故障演练]]

---

## 1 测试分层
- 单元测试：撮合规则、费用计算、冻结/解冻、状态机
- 集成测试：下单 -> 撮合 -> 清算 -> 资金/订单一致性
- 端到端：API/WS 回报、断线回补、限流与风控拒单

---

## 2 核心验收清单
### 2.1 资金一致性（必须为 0 容忍）
- 账本汇总与账户汇总一致（按资产、按用户抽样 + 全量夜间校验）
- 重试/重复事件不会导致多记账（幂等验证）

### 2.2 撮合正确性
- 价格优先、时间优先（覆盖边界价、同价多单）
- IOC/FOK/POST_ONLY（若支持）行为符合预期

### 2.3 回报一致性
- 订单回报状态与成交数量一致
- WebSocket 断线重连能恢复到正确状态（seq/快照对齐）

### 2.4 幂等与重复投递（必须覆盖）
- 下单幂等：同一 `clientOrderId` 重试不产生第二张订单（返回同一 `orderId` 或明确提示“已存在”）
- 撤单幂等：重复撤单不会报错导致客户端误判（可返回 `ORDER_NOT_FOUND` 但需说明“可视为成功”）
- 清算幂等：重复消费同一成交事件不会产生第二次记账（见 `LedgerEntry.idempotencyKey`）

### 2.5 风控与边界
- 精度/最小下单单位/最小成交额校验正确
- 价格保护正确（偏离阈值、滑点保护）
- 自成交保护（若启用）命中策略符合预期
- 限流生效：IP/用户/API Key/`symbol` 多维度覆盖

### 2.6 出入金与钱包（如启用）
- 充值去重：相同 `(asset, network, txid, index)` 不会重复入账
- 充值入账：确认数满足后才入账；入账写账本且可对账
- 提现幂等：重复提交同一幂等键不重复生成提现单/不重复出款
- 提现风控：2FA、地址白名单、限额、人工审核（如启用）生效
- 关闭出入金开关后：禁止新申请；在途单据处理策略清晰（继续/停止）

### 2.7 后台权限与审计（必须）
- RBAC：无权限无法调用高风险接口（提现审批/加减款/改费率/开关）
- 审计：关键操作必写 `AdminAuditLog`，且能还原 before/after
- 双人复核：人工加减款/大额提现无法绕过复核

---

## 3 压测与容量
### 3.1 指标（至少输出这些）
- 撮合：p50/p95/p99、队列长度、拒单率
- 清算：消费延迟（lag）、失败重试数、幂等去重命中率
- API：p99、错误码分布
- WS：推送 p99、断线率、订阅数、回补次数

### 3.2 场景（建议最小集）
- 单 `symbol` 热点：大量同价档订单 + 撤单风暴
- 跨 `symbol` 并发：多交易对同时高 TPS
- 行情订阅洪峰：大量连接订阅 `book/trades/kline`
- DB 压力：订单历史/账本查询并发（读压）

### 3.3 产出物
- 容量评估：单实例极限（撮合/清算/行情）、扩容曲线
- 配额建议：`symbol` 热点治理策略（限流/分流/暂停）

---

## 4 故障演练
### 4.1 必演练场景（上线前）
- 撮合实例重启：订单簿恢复策略验证（快照/增量/重放方案按实现）
- 清算实例重启：重复消费/幂等验证（不多记账）
- 行情断流：回补与降级策略验证（客户端能恢复）
- 数据库故障：只允许撤单/暂停下单（若设计支持）

### 4.2 演练验收口径
- 故障期间资金不丢、不重记
- 故障恢复后订单状态与成交/资金一致
- 降级开关可用且有审计留痕（谁在什么时候开启/关闭）

### 4.3 钱包与后台演练（如启用）
- 钱包节点/第三方故障：暂停自动入账/出款，切到安全降级策略
- 审批系统故障：高风险操作默认拒绝或暂停（安全优先）
