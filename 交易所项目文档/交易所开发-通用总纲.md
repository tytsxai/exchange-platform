---
title: 交易所开发-通用总纲
topic: 交易系统/交易所
tags:
  - 交易所
  - 架构
  - 系统设计
  - 风控
  - 撮合引擎
summary: >
  交易所（现货/合约）从产品到架构、核心模块（撮合、风控、清算）、数据与运维的通用开发要点清单与模板（不绑定具体项目）。
created: 2025-12-21
updated: 2025-12-30
stage: draft
visibility: internal
owner: me
ai_include: true
source: ""
---

# 交易所开发-通用总纲

> 用法：先填项目范围与里程碑，再按模块补细节；关键决策尽量写 ADR，避免散落在长文里。

- 项目范围与里程碑：[交易所项目-落地文档.md](交易所项目-落地文档.md)
- 统一术语与边界：[交易所项目-术语表.md](交易所项目-术语表.md)
- 架构决策记录（ADR）：[ADR/ADR-000-索引.md](ADR/ADR-000-索引.md)

## 0 目录
- [[#1 目标与范围]]
- [[#2 术语与假设]]
- [[#3 业务流程（端到端）]]
- [[#4 系统边界与模块拆分]]
- [[#5 核心：撮合引擎]]
- [[#6 核心：账户/资金]]
- [[#7 核心：风险控制]]
- [[#8 合约/杠杆（可选）]]
- [[#9 行情与市场数据]]
- [[#10 API 与接入]]
- [[#11 数据与审计]]
- [[#12 运维与可靠性]]
- [[#13 安全与合规]]
- [[#14 测试与验收]]
- [[#15 里程碑与迭代计划]]
- [[#附录A：需求清单模板]]
- [[#附录B：事件与消息命名建议]]
- [[#附录C：设计决策（ADR）]]

---

## 1 目标与范围
### 1.1 产品形态
- 交易类型：现货 / 永续合约 / 交割合约 / 杠杆（选择其一或组合）
- 参与方：C 端 / 机构 / 做市 / 内部盘
- 结算资产：法币 / 加密资产 / 积分（说明）

### 1.2 范围边界（明确“不做什么”）
- 本期不做：
- 延后做：

### 1.3 关键指标（SLO/业务）
- 可用性：例如 `99.9%`
- 延迟：撮合 p99（内存撮合）目标
- 吞吐：订单/秒、撮合/秒
- 数据一致性：资金账与成交账一致性目标

---

## 2 术语与假设
### 2.1 核心术语
- 订单（Order）：限价/市价/止损止盈/冰山/只做 maker 等（列出支持项）
- 成交（Trade）：撮合生成的成交记录
- 订单簿（Order Book）：买卖盘口
- 账户（Account）：用户维度的资产与保证金容器
- 账本（Ledger）：不可变资金流水（建议）
- 清算（Settlement）：将成交影响落到账户与账本

### 2.2 架构假设（先写出，再允许推翻）
- 一致性优先级：资金一致性 > 订单一致性 > 行情一致性
- 单撮合 vs 多撮合：按交易对/合约分片（写明策略）
- 货币精度：最小报价单位、最小成交量单位（写明）

---

## 3 业务流程（端到端）
### 3.1 充值/提现（如有）
1) 充值入账 -> 2) 可用余额变化 -> 3) 风控/反洗钱 -> 4) 审计留痕

### 3.2 下单到成交（核心链路）
1) 客户端下单
2) 网关鉴权/限流/签名校验
3) 预风控（额度/价格保护/仓位/保证金）
4) 冻结/预占资金（或预占保证金）
5) 撮合引擎入队与撮合
6) 成交事件 -> 清算服务 -> 更新账本/账户
7) 订单状态更新、推送、落库、行情更新

### 3.3 撤单/改单
- 撤单：生效点（撮合前/撮合中）与最终一致性策略
- 改单：是否支持（不支持则转为撤+下）

---

## 4 系统边界与模块拆分
### 4.1 逻辑模块
- 接入层：API 网关、鉴权、风控前置、限流、灰度
- 用户与安全：登录/2FA/API Key、权限与审计（后台）
- 交易域：订单服务、撮合引擎、清算/交割、风控
- 资金域：账户、账本、资产估值、费用与返佣
- 钱包域：充值/提现、地址管理、出款审批、链上对账（如启用出入金）
- 数据域：行情、K 线、订单/成交历史、报表
- 运营后台：交易对/费率/风控规则配置、提现审批、人工加减款（必须审计）
- 运维域：监控、告警、风控规则管理、开关与降级

### 4.2 数据一致性与事件驱动（建议）
- 关键写路径：撮合/清算/账本使用强一致（单分片串行或事务）
- 其他派生数据：事件流异步构建（行情、报表、搜索）

### 4.3 交易对/合约分片策略
- 分片键：`symbol`（交易对/合约）
- 同一 `symbol`：单线程/单 actor 保序（建议）
- 跨 `symbol`：并行处理

---

## 5 核心：撮合引擎
### 5.1 订单模型
- 字段：`order_id/user_id/symbol/side/type/price/qty/time_in_force/client_order_id`
- 订单状态：`INIT/NEW/PARTIALLY_FILLED/FILLED/CANCELED/REJECTED/EXPIRED`
- TIF：`GTC/IOC/FOK/POST_ONLY`（选择支持项）

### 5.2 撮合规则
- 价格优先、时间优先（或做市优先等）
- 自成交保护：是否允许同用户撮合
- 价格保护：偏离指数/标记价阈值（合约尤其重要）

### 5.3 处理模型（建议写清）
- 单 `symbol` 串行：保证订单簿与成交事件严格有序
- 事件输出（示例）：`OrderAccepted/OrderRejected/TradeCreated/OrderCanceled/BookSnapshot/BookDelta`

### 5.4 性能与内存结构
- OrderBook：双向链表 + 价格档位 map（或跳表/红黑树）
- 关键优化：批量撮合、对象池、零拷贝序列化（按语言选）

---

## 6 核心：账户/资金
### 6.1 账户与余额模型
- 余额拆分：`available/frozen`（现货）
- 账本建议：任何变动都对应一条不可变流水（方便审计与回放）

### 6.2 资金冻结与解冻
- 下单冻结：买单冻结 quote，卖单冻结 base
- 成交解冻：按成交量/成交额/手续费更新
- 撤单解冻：剩余冻结释放

### 6.3 费用模型
- 手续费：maker/taker、阶梯费率
- 返佣：邀请、渠道、做市（如有）

---

## 7 核心：风险控制
### 7.1 风控分层
- 前置风控（同步）：签名/限流/黑白名单/最小下单单位/价格保护/余额校验
- 交易风控（撮合前后）：反刷单、自成交限制、异常波动熔断
- 资金风控（清算）：透支保护、负余额保护、异常流水监控

### 7.2 熔断与降级
- 触发条件：延迟飙升、撮合队列积压、行情断流
- 策略：只读行情、暂停下单、只允许撤单、分交易对暂停

---

## 8 合约/杠杆（可选）
### 8.1 仓位与保证金
- 仓位：全仓/逐仓
- 保证金：初始/维持
- 价格体系：指数价/标记价/最新价（各自用途）

### 8.2 强平与爆仓
- 触发：保证金率 < 阈值
- 流程：冻结 -> 减仓/平仓 -> 穿仓处理 -> 保险基金（如有）

### 8.3 资金费率（永续）
- 周期、计费方式、结算入账链路

---

## 9 行情与市场数据
### 9.1 行情来源
- 内部撮合产出：逐笔成交、盘口增量
- 外部参考：指数（多交易所）用于合约标记价

### 9.2 推送与存储
- 推送：WebSocket 频道规划（按 `symbol` 分区）
- 存储：K 线聚合（1m/5m/1h/1d）与回补策略

---

## 10 API 与接入
### 10.1 API 形态
- REST：下单/撤单/查询/资金
- WebSocket：行情/订单回报/账户变更
- 回调：成交回报（机构/做市）

### 10.2 鉴权与签名
- API Key/Secret、Nonce/时间戳、重放保护
- 权限：只读/交易/提现（如有）

### 10.3 幂等与一致性
- `client_order_id` 幂等键
- 查询一致性：写后读延迟与最终一致性说明

---

## 11 数据与审计
### 11.1 数据落地原则
- 以「事件/账本」为源（source of truth）
- 派生表可重建：订单聚合、持仓报表、K 线

### 11.2 审计
- 关键行为留痕：登录、资金变动、风控命中、配置变更
- 可回放：从事件流重放订单簿与资金（可选）

---

## 12 运维与可靠性
### 12.1 可观测性
- 指标：撮合队列长度、撮合耗时、拒单率、资金一致性校验失败数
- 日志：请求链路追踪（trace id）
- 告警：按 `symbol` 维度定位问题

### 12.2 灾备与恢复
- RPO/RTO 目标
- 多副本与冷备：订单簿快照 + 增量日志（如果采用）

---

## 13 安全与合规
### 13.1 安全
- 风险点：API 重放、订单注入、越权、余额篡改
  - 措施：最小权限、密钥轮换、敏感操作二次确认（如有）
  - 后台：RBAC + 全量审计 + 高风险双人复核（见 [ADR/ADR-006-后台权限与审计模型.md](ADR/ADR-006-后台权限与审计模型.md)）
  - 钱包：出入金风控/审批/对账（见 [ADR/ADR-005-出入金与钱包架构.md](ADR/ADR-005-出入金与钱包架构.md)）

### 13.2 合规（按地区）
- KYC/AML（如涉及）
- 数据留存与审计要求

---

## 14 测试与验收
### 14.1 测试分层
- 单元测试：撮合规则、费用计算、冻结/解冻
- 集成测试：下单->成交->清算一致性
- 压测：峰值订单、峰值行情推送

### 14.2 验收清单（示例）
- 资金不丢：任意时点 `账本汇总 == 账户汇总`（按资产）
- 订单一致：订单状态与成交数量一致
- 断电恢复：撮合/清算恢复后数据一致

---

## 15 里程碑与迭代计划
- MVP（现货最小闭环）：注册/登录（如需要）-> 充值（可选）-> 下单/撤单 -> 撮合 -> 清算 -> 订单与成交查询 -> 行情推送
- V1：风控规则平台、费率与返佣、K 线、报表
- V2：合约（保证金/强平/资金费率）、指数/标记价体系

---

# 附录A：需求清单模板
- 支持的订单类型：
- 支持的 TIF：
- 交易对列表与精度：
- 手续费与返佣：
- 限流策略（API/用户/IP）：
- 风控规则（拒单/熔断/黑白名单）：
- 监管/合规要求（如有）：

# 附录B：事件与消息命名建议
- `OrderAccepted`
- `OrderRejected`
- `OrderCanceled`
- `TradeCreated`
- `BookSnapshot`
- `BookDelta`
- `AccountBalanceChanged`
- `PositionChanged`（合约）
- `MarkPriceUpdated`（合约）

# 附录C：设计决策（ADR）
> ADR 已迁移到独立目录：`ADR/`，从这里进入：[ADR/ADR-000-索引.md](ADR/ADR-000-索引.md)。
