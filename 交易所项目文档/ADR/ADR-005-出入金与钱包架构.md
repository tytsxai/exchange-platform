---
title: ADR-005-出入金与钱包架构
topic: 项目文档/ADR
tags:
  - 交易所
  - 钱包
  - 出入金
  - 安全
  - ADR
summary: >
  记录出入金与钱包系统的边界与关键策略：地址/确认数/入账、提现审批与出款、热冷钱包、对账与容灾。
created: 2025-12-21
updated: 2025-12-21
stage: draft
visibility: internal
owner: me
ai_include: true
source: ""
---

# ADR-005-出入金与钱包架构

## 背景
- 出入金是交易所最高风险链路之一：涉及真实资产、链上不可逆、攻击面大（私钥、风控绕过、地址替换、重复入账等）。
- 架构目标：资金安全优先，其次是可用性与自动化；所有动作必须可审计、可对账、可追溯。

## 决策（建议默认）
### 1) 模块边界
- 单独钱包服务（Wallet Service）负责：
  - 链上监听/确认数统计（Deposit Observer）
  - 充值入账触发（Credit）
  - 提现申请队列与审批流（Withdraw Workflow）
  - 出款执行（Payout Executor）
  - 链上对账（Reconciliation）
- 交易核心（撮合/清算）不直接依赖链上节点；只消费“充值入账/提现完成”等资金事件并写账本。

### 2) 充值入账策略
- 入账条件：`confirmations >= confirmationsRequired`（按资产/网络配置）。
- 去重：以 `(asset, network, txid, vout/index)` 建唯一约束，防止重复入账。
- 入账动作：写账本 `LedgerEntry(reason=DEPOSIT, refId=depositId)`，并更新余额快照。
- 异常处理：
  - 重组/回滚（如链支持）：需要“冻结/冲正”机制（先在文档预留，具体按链实现能力）

### 3) 提现与审批策略
- 提现申请：必须幂等（`idempotencyKey` 唯一），申请时先冻结资金（或预扣）。
- 强制安全措施（建议默认启用）：
  - 2FA
  - 地址白名单（可选，但强烈建议）
  - 限额（按用户/资产/时间窗）
  - 风险评分（可后续增强）
- 审批：支持人工审核（双人复核）+ 审计日志；必要时可引入自动审批规则。
- 出款：从“提现队列”取任务执行，写入 `txid`，并最终写账本 `LedgerEntry(reason=WITHDRAW, refId=withdrawId)`（或在冻结阶段 + 出款阶段分两笔记账，按资金模型确定）。

### 4) 热/冷钱包与密钥管理（能力预留）
- MVP/V1 阶段可先使用托管/第三方（如合规可行），但必须：
  - 私钥与签名隔离（HSM/冷存储/多签）
  - 最小权限与审批流程
  - 出款批处理与限额

### 5) 对账与审计
- 链上对账作业：按资产/网络核对链上余额、出入金流水与账本一致。
- 所有审批/出款/配置变更必须写 `AdminAuditLog`（见 [ADR-006-后台权限与审计模型.md](ADR-006-后台权限与审计模型.md) / [../交易所项目-数据模型.md](../交易所项目-数据模型.md)）。

## 备选方案
- 方案 A：交易核心直接对接链节点
  - 缺点：强耦合、稳定性与安全风险扩散到核心链路（不推荐）
- 方案 B：完全依赖第三方托管（无自建钱包能力）
  - 优点：上线快
  - 缺点：供应商风险、成本与可控性不足（可作为早期过渡）

## 影响
- 正向：风险隔离，链上故障不影响撮合；出入金可独立扩容与降级；审计与对账口径清晰。
- 代价：需要额外服务与运维；需要对不同链的差异做适配与测试。

## 验证与回滚
- 验证：
  - 充值重复推送/节点重启不会重复入账（唯一键 + 账本幂等）
  - 提现重复提交不会重复出款（幂等键 + 审批流）
  - 对账作业能定位差异到具体 `depositId/withdrawId/txid`
- 回滚/降级：
  - 出入金出现风险事件：立即关闭出入金开关，只保留站内交易与撤单
  - 节点/第三方不稳定：暂停自动出款，切到人工审核与延迟出款
