---
title: ADR-007-事件总线与Outbox一致性
topic: 项目文档/ADR
tags:
  - 交易所
  - 事件驱动
  - Outbox
  - 一致性
  - ADR
summary: >
  记录交易所事件驱动架构的关键选择：事件总线/Topic 规划、至少一次投递、Outbox 模式保证“写库与发事件”的一致性，以及回放与幂等策略。
created: 2025-12-21
updated: 2025-12-21
stage: draft
visibility: internal
owner: me
ai_include: true
source: ""
---

# ADR-007-事件总线与Outbox一致性

## 背景
- 交易所的很多派生数据（行情、K 线、报表、搜索、通知）适合事件驱动异步构建。
- 但资金与订单链路不能接受“写库成功但事件丢失”或“事件发出但写库失败”的不一致。

## 决策（建议默认）
### 1) 投递语义
- 事件总线采用“至少一次投递”（at-least-once）。
- 消费端必须幂等（用唯一键/幂等键去重），并允许重复事件重放。

### 2) Outbox 模式保证一致性
- 在同一数据库事务中：
  1) 写入业务表（如 `LedgerEntry/Order`）
  2) 同时写入 `OutboxEvent`（事件表）
- Outbox Relay（独立进程/任务）持续扫描 `OutboxEvent` 并发布到事件总线；发布成功后标记已发送。

### 3) 分区与保序
- 分区键（建议）：`symbol`（交易/行情相关事件）、`userId`（用户资金/通知相关事件）
- 保序原则：
  - 同一 `symbol` 的撮合/行情事件必须有序
  - 同一 `userId+asset` 的资金事件必须有序（最终以账本写入保序为准）

### 4) 事件版本与兼容
- 每个事件 `eventType + version` 定义 payload schema
- 只做向后兼容变更（新增字段）；破坏性变更通过提升 `version` 实现

## 备选方案
- 方案 A：业务服务直接发事件（无 outbox）
  - 风险：写库与发事件无法原子一致（不推荐）
- 方案 B：事务消息（依赖特定 MQ 的事务能力）
  - 优点：一致性强
  - 缺点：与基础设施绑定，复杂度高（可选）

## 影响
- 正向：事件不会丢；可回放重建派生数据；故障恢复更可控。
- 代价：需要 outbox 表与 relay；需要处理消费幂等、积压与重试。

## 验证与回滚
- 验证：
  - 写库后即使 MQ 短暂不可用，事件最终也会被投递（outbox backlog 可见）
  - 消费端重复消费不会产生重复资金变动（依赖唯一键/幂等键）
- 回滚：
  - MQ 故障时可暂停 outbox relay，不影响资金写库；派生数据延迟恢复即可
