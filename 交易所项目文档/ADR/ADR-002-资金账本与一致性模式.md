---
title: ADR-002-资金账本与一致性模式
topic: 项目文档/ADR
tags:
  - 交易所
  - 资金
  - 账本
  - 一致性
  - ADR
summary: >
  记录资金与账户的 source of truth（账本/账户表）、清算写路径的一致性策略，以及对审计与回放的影响。
created: 2025-12-21
updated: 2025-12-21
stage: draft
visibility: internal
owner: me
ai_include: true
source: ""
---

# ADR-002-资金账本与一致性模式

## 背景
- 资金链路必须“强一致、可审计、可追溯”，且能抵抗重复请求/重复事件/服务重启带来的重复记账。
- 交易所最难的问题不是撮合，而是“钱”和“状态机”：任何一次资金差错都会导致不可逆的信任与合规风险。

## 决策（建议默认）
### 1) source of truth
- 采用“不可变账本（LedgerEntry）”作为资金变动的 source of truth。
- `AccountBalance` 作为“可重建快照/读模型”（但仍可在交易链路中同步更新以提升查询性能）。

### 2) 写路径一致性（清算/冻结/解冻）
- 所有会影响资金的动作（下单冻结、撤单解冻、成交清算、手续费、返佣、运营加减款、出入金）统一走清算写路径。
- 每次资金变动：**先写账本，再更新余额快照**，并在同一数据库事务内提交（或在同一单写入分区内严格保序提交）。
- 资金写入必须满足：同一 `userId + asset` 串行（可以用行锁、乐观锁版本号、或按分区单线程消费保证）。

### 3) 幂等键与去重
- 账本层：每条 `LedgerEntry` 必须有 `idempotencyKey`，并对其建立唯一约束。
  - 冻结：`ORDER_FREEZE:{orderId}:{asset}`
  - 撤单解冻：`ORDER_UNFREEZE:{orderId}:{asset}`
  - 成交清算：`TRADE_SETTLE:{tradeId}:{userId}:{asset}:{legType}`
- 清算消费层：允许“至少一次投递”，依赖 `idempotencyKey` 做最终去重；提交消费位点必须晚于数据库事务提交。

## 备选方案
### 方案 A：只维护余额表（无账本）
- 优点：实现简单、写入少
- 缺点：审计困难、难以对账、事故后难以恢复与解释（不推荐）

### 方案 B：事件溯源（Event Sourcing），余额完全由事件流计算
- 优点：回放强、审计强
- 缺点：工程复杂度高；对查询与一致性要求更高（适合成熟团队）

### 方案 C：账本为 truth + 余额快照同步更新（本 ADR 默认）
- 优点：审计清晰、可对账、查询性能可控、工程复杂度适中

## 影响
- 正向影响：资金可追溯、可对账；重复事件不会造成多记账；事故定位更快。
- 代价：写路径更重；需要仔细设计 `LedgerEntry` 字段与并发控制；需要对账与校验作业。

## 需要统一的字段/口径（落到数据模型）
- 建议 `LedgerEntry` 同时记录 `availableDelta/frozenDelta` 与 `availableAfter/frozenAfter`（便于审计）。
- 明确手续费扣费资产与入账规则（扣 quote / 扣 base / 平台币抵扣等）。

## 验证与回滚
### 验证
- 幂等：重复投递同一 `tradeId/orderId` 不会产生第二条有效资金变动（唯一键命中）。
- 不变式（invariants）：
  - 任意时点 `available >= 0 && frozen >= 0`
  - 任意时点“余额快照 == 账本聚合”（抽样 + 夜间全量）

### 回滚/降级
- 若账本写入成为瓶颈：优先做“写入分区扩展/按资产或用户分片”，而不是绕过账本。
- 若余额快照更新导致锁竞争：可暂时将余额快照改为异步更新，但账本仍必须强一致落地。
