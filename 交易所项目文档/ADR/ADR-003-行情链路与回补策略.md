---
title: ADR-003-行情链路与回补策略
topic: 项目文档/ADR
tags:
  - 交易所
  - 行情
  - WebSocket
  - ADR
summary: >
  记录行情生成链路（撮合直出/事件流聚合）、推送频道规划、断流检测与历史回补策略。
created: 2025-12-21
updated: 2025-12-21
stage: draft
visibility: internal
owner: me
ai_include: true
source: ""
---

# ADR-003-行情链路与回补策略

## 背景
- 行情是“可用性与体验”的关键链路，但其一致性优先级低于资金与订单。
- 行情链路必须能处理：高频推送、断线重连、丢包/乱序、以及“快照 + 增量”对齐问题。
- 行情应尽量可重建：来源应是撮合输出的事件，而不是数据库轮询。

## 决策（建议默认）
### 1) 行情来源
- 撮合引擎输出两类事件作为行情源：
  - `TradeCreated`：逐笔成交
  - `BookDelta`（或 `OrderBookUpdated`）：盘口增量（按 `symbol` 严格有序）
- 行情服务（MarketData Service）按 `symbol` 分区消费事件流，维护内存订单簿视图，并负责对外推送与落地。

### 2) 推送频道规划
- 公共频道（按 `symbol` 分区，便于扩展）：
  - `market.{symbol}.trades`
  - `market.{symbol}.book`
  - `market.{symbol}.kline.{interval}`
- 私有频道与订单回报分离（避免公共行情与私有回报互相影响延迟）。

### 3) 序列号（seq）与回补策略
- 每个 `symbol` 的 `book` 与 `trades` 维护单调递增 `seq`（可共用或分别维护，但要写清口径）。
- REST 提供 `GET /v1/depth` 返回“订单簿快照 + snapshotSeq”。
- WS 推送的 `BookDelta` 必须包含 `seq` 与 `prevSeq`（或等价信息）：
  - 客户端检测 gap：`prevSeq != lastSeq` 则判定丢包，立即重拉快照并重置 `lastSeq`。
- 回补方式优先级（从简单可靠开始）：
  1) 丢包即重拉快照（MVP 推荐）
  2) 进阶：提供增量回补接口（按 seq 区间拉取）+ 快照对齐

## 备选方案
### 方案 A：数据库轮询生成行情
- 缺点：延迟高、成本高、在高频下不可控（不推荐）

### 方案 B：撮合直推 WS（无中间层）
- 优点：链路短、延迟低
- 缺点：撮合被迫承担连接管理与广播压力，影响核心撮合（不推荐）

### 方案 C：撮合事件流 -> 行情聚合服务（本 ADR 默认）
- 优点：解耦撮合与推送；可水平扩展；易于落地回补与存储

## 影响
- 正向：撮合专注交易核心；行情服务可独立扩容与降级；断线回补策略清晰。
- 风险：需要保证撮合输出事件的有序与完整；行情服务需维护快照与 seq。

## 验证与回滚
### 验证
- 人为制造丢包：客户端能检测 gap 并重拉快照后恢复一致盘口。
- 高压订阅：WS 推送延迟与断线率满足目标（见 Runbook 指标）。

### 回滚/降级
- 行情服务压力过大：优先降级 `book` 频率/深度，保留 `trades`；必要时只提供 REST 快照。
