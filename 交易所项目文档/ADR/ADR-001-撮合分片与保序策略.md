---
title: ADR-001-撮合分片与保序策略
topic: 项目文档/ADR
tags:
  - 交易所
  - 撮合引擎
  - 分片
  - 一致性
  - ADR
summary: >
  记录撮合引擎的分片键、同分片内保序方式、跨分片并行策略，以及对行情/清算/故障恢复的影响。
created: 2025-12-21
updated: 2025-12-21
stage: draft
visibility: internal
owner: me
ai_include: true
source: ""
---

# ADR-001-撮合分片与保序策略

## 背景
- 撮合需要高吞吐与严格有序（同一订单簿不能乱序）。
- 系统需要可水平扩展（多 `symbol` 并行）。

## 决策（建议默认）
- 分片键：`symbol`
- 保序：同一 `symbol` 的订单与撮合事件单线程/单 actor 串行处理
- 并行：不同 `symbol` 可并行；撮合输出事件由清算按 `symbol` 分区消费

## 细化说明（落地要点）
- `symbol` 与撮合实例映射需要可配置（便于热点迁移与扩容）。
- 热点治理优先级（从易到难）：
  1) 限流/熔断热点 `symbol`
  2) 按 `symbol` 横向扩容撮合实例（把热点迁移到独立实例）
  3) 只有当“单一 `symbol` 必须超高 TPS”时才考虑二级分片（实现成本显著上升）

## 备选方案
- 单机全量撮合：实现简单，但扩展性差
- 多分片撮合 + 全局队列：复杂度高，容易引入跨分片一致性问题

## 影响
- 优点：订单簿逻辑简单、事件严格有序、易定位问题
- 风险：热点 `symbol` 成为瓶颈；需要热点治理（限流/按交易对拆分/做市隔离等）

## 验证与回滚
- 验证：压测同 `symbol` 峰值、跨 `symbol` 并发；回放重建订单簿一致
- 回滚：必要时先“按 `symbol` 扩容实例”，最后才考虑“二级分片（按价格档/用户）”
