---
title: 交易所项目-实现总结
topic: 项目文档/交易所
tags:
  - 交易所
  - 实现
  - 部署
summary: >
  交易所项目的实际实现总结：已完成的服务、技术栈、部署方式、API 端点、已知问题与后续计划。
created: 2025-12-22
updated: 2025-12-30
stage: implemented
visibility: internal
owner: me
ai_include: true
---

# 交易所项目-实现总结

## 1 技术栈

| 层级 | 技术选型 |
|------|----------|
| 语言 | Go 1.25+ |
| 数据库 | PostgreSQL 16（开发 compose 默认） |
| 消息队列 | Redis Streams |
| 容器化 | Docker Compose（`docker compose` v2；亦兼容 `docker-compose`） |
| 监控 | Prometheus + Grafana |
| 链路追踪 | Jaeger |

## 2 服务清单

### 2.1 已实现服务

| 服务 | 端口 | 仓库 | 功能 |
|------|------|------|------|
| exchange-common | - | exchange-common | Proto 定义、公共库、DB Schema、Docker Compose |
| exchange-gateway | 8080 | exchange-gateway | API 网关、HMAC-SHA256 签名验证、IP/用户限流 |
| exchange-user | 8085 | exchange-user | 用户注册/登录、API Key 管理 |
| exchange-order | 8081 | exchange-order | 订单创建/取消、价格保护、发送 Redis Stream |
| exchange-matching | 8082 | exchange-matching | 撮合引擎、价格时间优先、内存订单簿 |
| exchange-clearing | 8083 | exchange-clearing | 资金清算、余额账本、乐观锁 |
| exchange-marketdata | 8084/8094(WS) | exchange-marketdata | 行情 REST + WebSocket 推送 |
| exchange-admin | 8087 | exchange-admin | RBAC、交易对配置、Kill Switch |
| exchange-wallet | 8086 | exchange-wallet | 充值地址、提现审批 |

### 2.2 数据流

```
Client
   │
   ▼
┌─────────────────┐
│  Gateway:8080   │ ← 签名验证、限流
└────────┬────────┘
         │
    ┌────┴────┬─────────────┐
    ▼         ▼             ▼
┌───────┐ ┌───────┐    ┌─────────┐
│User   │ │Order  │    │Clearing │
│:8085  │ │:8081  │    │:8083    │
└───────┘ └───┬───┘    └────▲────┘
              │             │
              ▼             │
        Redis Stream        │
        (exchange:orders)   │
              │             │
              ▼             │
        ┌─────────┐         │
        │Matching │─────────┘
        │:8082    │    (exchange:events)
        └────┬────┘
             │
             ▼
        Redis Stream
        (exchange:events)
             │
    ┌────────┼────────┐
    ▼        ▼        ▼
┌───────┐ ┌──────────┐ ┌──────────┐
│Order  │ │Clearing  │ │MarketData│
│更新   │ │:8083     │ │:8084     │
└───────┘ └──────────┘ └──────────┘
```

### 2.3 前端现状

- 本仓库当前交付物为**后端服务**（REST/WS API + 运行与运维脚本）。
- **不包含独立的 Web 前端/管理后台前端项目**（例如 `exchange-web`、`exchange-admin-frontend`）。
- 可用于联调/验收的“前端入口”是各服务内置的 **Swagger UI**（`/docs`）以及 `sdk/typescript` 的 OpenAPI 生成 SDK。

## 3 部署指南

### 3.1 前置条件

- Docker & Docker Compose（`docker compose`）
- Go 1.25+
- （可选）本地 PostgreSQL/Redis：使用 `exchange-common/scripts/start-all.sh` 会通过 compose 自动拉起 dev infra

### 3.2 快速启动

```bash
# 1. 一键启动（包含：启动 dev infra、跑迁移、编译并启动全部服务）
bash exchange-common/scripts/start-all.sh start

# 2. 查看状态
bash exchange-common/scripts/start-all.sh status

# 3. 停止（含 infra）
bash exchange-common/scripts/start-all.sh stop

# 4. E2E（需服务在跑）
bash scripts/e2e-test.sh
```

可选开关：
- 允许“部分服务失败也继续启动”：`ALLOW_PARTIAL_START=1`
- 允许“迁移失败也继续启动”（不推荐）：`ALLOW_MIGRATE_FAIL=1`

### 3.3 环境变量

完整生产示例见 `deploy/prod/prod.env.example`（建议作为唯一权威列表）。

通用变量（多服务共享）：

| 变量 | 默认值 | 说明 |
|------|--------|------|
| APP_ENV | dev | 环境标识；非 dev 会触发强校验 |
| SERVICE_NAME | 服务名 | 服务标识 |
| INTERNAL_TOKEN | 必填 | 内部服务鉴权令牌（服务间调用） |
| AUTH_TOKEN_SECRET | 必填 | Bearer Token（`v1.<payload>.<signature>`）签名密钥（>=32 字符） |
| AUTH_TOKEN_TTL | 24h | Bearer Token 过期时间 |
| ADMIN_TOKEN | 必填 | 高风险管理接口额外保护（`X-Admin-Token`） |
| API_KEY_SECRET_KEY | 必填 | API Key Secret 加密密钥（AES-GCM；>=32 字符） |
| DB_HOST | localhost | PostgreSQL 主机 |
| DB_PORT | 5436 | PostgreSQL 端口 |
| DB_USER | exchange | 数据库用户 |
| DB_PASSWORD | exchange123 | 数据库密码（非 dev 禁止默认值） |
| DB_NAME | exchange | 数据库名 |
| DB_SSL_MODE | disable | PostgreSQL SSL 模式（非 dev 禁止 disable） |
| DB_MAX_OPEN_CONNS | 50 | 连接池最大连接数 |
| DB_MAX_IDLE_CONNS | 10 | 连接池最大空闲连接 |
| DB_CONN_MAX_LIFETIME | 30m | 连接最大生命周期 |
| DB_CONN_MAX_IDLE_TIME | 5m | 连接最大空闲时间 |
| REDIS_ADDR | localhost:6380 | Redis 地址 |
| REDIS_PASSWORD | "" | Redis 密码（非 dev 必填） |
| ORDER_STREAM | exchange:orders | 订单流 |
| EVENT_STREAM | exchange:events | 事件流 |
| PRIVATE_USER_EVENT_CHANNEL | private:user:{userId}:events | 私有推送通道模板 |
| WORKER_ID | 各服务不同 | Snowflake Worker ID |

端口变量（建议使用服务前缀，避免多服务冲突）：
- `GATEWAY_HTTP_PORT` (8080) / `GATEWAY_WS_PORT` (8090)
- `ORDER_HTTP_PORT` (8081)
- `MATCHING_HTTP_PORT` (8082) / `MATCHING_METRICS_PORT` (9082)
- `CLEARING_HTTP_PORT` (8083) / `CLEARING_GRPC_PORT` (9083)
- `MARKETDATA_HTTP_PORT` (8084) / `MARKETDATA_WS_PORT` (8094)
- `USER_HTTP_PORT` (8085)
- `WALLET_HTTP_PORT` (8086)
- `ADMIN_HTTP_PORT` (8087)

常用专属开关（按服务启用）：
- `ENABLE_DOCS` / `ALLOW_DOCS_IN_NONDEV`（Gateway/Admin/Wallet）
- `CORS_ALLOW_ORIGINS`（Gateway）
- `TRUSTED_PROXY_CIDRS`（Gateway，显式信任反代/LB 的 CIDR）
- `IP_RATE_LIMIT` / `USER_RATE_LIMIT`（Gateway）
- `MARKETDATA_WS_ALLOW_ORIGINS` / `MARKETDATA_WS_MAX_SUBSCRIPTIONS`（MarketData）
- `PRICE_PROTECTION_ENABLED` / `PRICE_PROTECTION_DEFAULT_LIMIT_RATE`（Order）
- `DEPOSIT_SCANNER_ENABLED` / `ALLOW_MVP_DEPOSIT_SCANNER`（Wallet）

## 4 API 端点

说明：完整字段与示例请以 `exchange-gateway/api/openapi.yaml` 为准。

### 4.1 公共接口

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /health | 健康检查 |
| GET | /v1/ping | Ping |
| GET | /v1/time | 服务器时间 |
| GET | /v1/exchangeInfo | 交易对信息 |
| GET | /v1/depth | 市场深度 |
| GET | /v1/trades | 最近成交 |
| GET | /v1/ticker | 24h 行情 |

### 4.2 认证与 API Key（Bearer）

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | /v1/auth/register | 用户注册 |
| POST | /v1/auth/login | 用户登录 |
| POST | /v1/apiKeys | 创建 API Key |
| GET | /v1/apiKeys | API Key 列表 |
| DELETE | /v1/apiKeys/{apiKeyId} | 删除 API Key |

### 4.3 交易接口（需签名）

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | /v1/order | 创建订单 |
| DELETE | /v1/order | 取消订单 |
| GET | /v1/order | 单笔订单 |
| GET | /v1/openOrders | 当前挂单 |
| GET | /v1/allOrders | 所有订单 |
| GET | /v1/myTrades | 成交记录 |

### 4.4 资产接口（需签名）

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /v1/account | 账户余额 |
| GET | /v1/ledger | 资金流水 |

### 4.5 WebSocket

| 端点 | 说明 |
|------|------|
| ws://localhost:8094/ws | 行情 WebSocket |
| ws://localhost:8090/ws/private | 私有推送 WebSocket（Gateway） |

行情订阅消息格式（MarketData WS）：
```json
{"op":"subscribe","channel":"market.BTCUSDT.book"}
{"op":"subscribe","channel":"market.BTCUSDT.trades"}
{"op":"subscribe","channel":"market.BTCUSDT.ticker"}
```

私有推送（Gateway `/ws/private`）不需要订阅消息：连接时用签名参数鉴权后，服务端会按用户推送事件。

补充说明（实现细节）：
- API Key secret 以加密形式存储（AES-GCM，密钥来自 `API_KEY_SECRET_KEY`），签名校验时会解密后使用。
- API Key 支持 IP 白名单校验，网关会透传可信客户端 IP 供 user-service 验签。
- 交易签名默认参与 `bodyHash`（`sha256(body)`）校验；网关目前**默认兼容 legacy（无 bodyHash）**，但新客户端建议在有请求体时携带 `bodyHash`。

## 5 近期修复记录（已验证）

- 统一 Go 版本与构建基线：仓库与 CI/镜像构建对齐到 Go 1.25。
- 启动脚本改为默认 fail-fast：迁移/编译/启动失败会直接报错并清理；同时兼容 `docker compose` / `docker-compose`。
- 迁移脚本容错：当 DB 已通过 init 方式初始化但未写入 `schema_migrations` 时，会自动补记避免重复执行非幂等 DDL。
- 私有推送 WebSocket：Gateway 现在会在 `GATEWAY_WS_PORT`（默认 8090）监听 `/ws/private`。
- 清算余额更新加入乐观锁失败重试，降低并发更新冲突导致的失败率。
- 订单更新器对异常事件写入 DLQ（`<stream>:dlq`）并记录原因，便于排查。
- Trade ID 全局唯一：撮合引擎生成的 tradeId 现在跨 symbol 全局递增，便于审计与回放。
- Streams 消费活性检测：`matching/order/clearing/marketdata` 的 `/ready` 会检查消费循环活性。
- E2E 与 WS 测试稳定性：修复测试脚本中的竞态条件和超时问题。

### 5.3 待优化项（P2）

- [ ] 参数验证增强（symbol 格式、userID 边界）
- [ ] 结构化日志（替换 log.Printf）
- [ ] 配置外部化（移除硬编码测试密钥）
- [ ] 数据库连接池配置
- [ ] 优雅关闭超时处理

## 6 数据库 Schema

完整 Schema 位于 `exchange-common/scripts/init-db.sql`，包含：

- `exchange_user` - 用户、API Key
- `exchange_order` - 订单、交易对配置
- `exchange_clearing` - 余额、账本流水
- `exchange_market` - K 线
- `exchange_admin` - 角色、权限、审计日志
- `exchange_wallet` - 资产、网络、充值、提现

## 7 后续计划

### 7.1 功能增强

- [ ] K 线聚合服务
- [ ] 风控服务（价格保护、自成交保护）
- [ ] 2FA 支持
- [ ] KYC/AML 预留接口

### 7.2 运维增强

- [ ] Kubernetes 部署配置
- [ ] 分布式追踪集成
- [ ] 告警规则配置
- [ ] 自动化备份脚本

### 7.3 性能优化

- [ ] 撮合引擎性能测试
- [ ] 数据库索引优化
- [ ] Redis 集群支持
- [ ] 连接池调优

## 8 参考文档

- 架构总览：[交易所项目-架构总览.md](交易所项目-架构总览.md)
- 接口契约：[交易所项目-接口契约.md](交易所项目-接口契约.md)
- 数据模型：[交易所项目-数据模型.md](交易所项目-数据模型.md)
- 任务路线图：[交易所项目-任务拆解与路线图.md](交易所项目-任务拆解与路线图.md)
