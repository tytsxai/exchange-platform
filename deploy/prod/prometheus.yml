global:
  scrape_interval: 15s
  evaluation_interval: 15s

rule_files:
  - /etc/prometheus/alerts.yml

alerting:
  alertmanagers:
    - static_configs:
        - targets: ["alertmanager:9093"]

# Production-oriented scrape example:
# - Targets use compose service DNS names on `exchange-prod-net`.
# - If you set `METRICS_TOKEN` on services, mount a token file and enable `bearer_token_file` below.
scrape_configs:
  - job_name: "exchange-gateway"
    metrics_path: /metrics
    # bearer_token_file: /etc/prometheus/metrics.token
    static_configs:
      - targets: ["gateway:8080"]

  - job_name: "exchange-order"
    metrics_path: /metrics
    # bearer_token_file: /etc/prometheus/metrics.token
    static_configs:
      - targets: ["order:8081"]

  - job_name: "exchange-matching"
    metrics_path: /metrics
    # bearer_token_file: /etc/prometheus/metrics.token
    static_configs:
      - targets: ["matching:8082"]

  - job_name: "exchange-clearing"
    metrics_path: /metrics
    # bearer_token_file: /etc/prometheus/metrics.token
    static_configs:
      - targets: ["clearing:8083"]

  - job_name: "exchange-marketdata"
    metrics_path: /metrics
    # bearer_token_file: /etc/prometheus/metrics.token
    static_configs:
      - targets: ["marketdata:8084"]

  - job_name: "exchange-user"
    metrics_path: /metrics
    # bearer_token_file: /etc/prometheus/metrics.token
    static_configs:
      - targets: ["user:8085"]

  - job_name: "exchange-wallet"
    metrics_path: /metrics
    # bearer_token_file: /etc/prometheus/metrics.token
    static_configs:
      - targets: ["wallet:8086"]

  - job_name: "exchange-admin"
    metrics_path: /metrics
    # bearer_token_file: /etc/prometheus/metrics.token
    static_configs:
      - targets: ["admin:8087"]

  # Probe service readiness endpoints and alert if they stay degraded.
  - job_name: "service-ready"
    metrics_path: /probe
    params:
      module: [http_ready]
    static_configs:
      - targets:
          - http://gateway:8080/ready
          - http://user:8085/ready
          - http://order:8081/ready
          - http://matching:8082/ready
          - http://clearing:8083/ready
          - http://marketdata:8084/ready
          - http://wallet:8086/ready
          - http://admin:8087/ready
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: blackbox-exporter:9115
