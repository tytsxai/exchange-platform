services:
  # NOTE:
  # - Default production posture: only expose gateway (and optionally marketdata WS) to the public internet.
  # - Postgres/Redis are expected to be managed/external in production (TLS + auth).
  # - For a full local stack, use `exchange-common/docker-compose.yml` for infra and run services via scripts.

  gateway:
    image: exchange-gateway:${APP_VERSION:-latest}
    build:
      context: ../..
      dockerfile: deploy/prod/Dockerfile.go-service
      args:
        SERVICE_DIR: exchange-gateway
        CMD_DIR: gateway
    env_file:
      - ${PROD_ENV_FILE:-./prod.env}
    ports:
      - "8080:8080"
      - "8090:8090"
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl -fsS http://localhost:8080/ready >/dev/null || exit 1",
        ]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 20s
    restart: unless-stopped
    stop_grace_period: 20s
    init: true
    depends_on: []
    networks: [exchange-net]

  user:
    image: exchange-user:${APP_VERSION:-latest}
    build:
      context: ../..
      dockerfile: deploy/prod/Dockerfile.go-service
      args:
        SERVICE_DIR: exchange-user
        CMD_DIR: user
    env_file:
      - ${PROD_ENV_FILE:-./prod.env}
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl -fsS http://localhost:8085/ready >/dev/null || exit 1",
        ]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 20s
    restart: unless-stopped
    stop_grace_period: 20s
    init: true
    networks: [exchange-net]

  order:
    image: exchange-order:${APP_VERSION:-latest}
    build:
      context: ../..
      dockerfile: deploy/prod/Dockerfile.go-service
      args:
        SERVICE_DIR: exchange-order
        CMD_DIR: order
    env_file:
      - ${PROD_ENV_FILE:-./prod.env}
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl -fsS http://localhost:8081/ready >/dev/null || exit 1",
        ]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 20s
    restart: unless-stopped
    stop_grace_period: 20s
    init: true
    networks: [exchange-net]

  matching:
    image: exchange-matching:${APP_VERSION:-latest}
    build:
      context: ../..
      dockerfile: deploy/prod/Dockerfile.go-service
      args:
        SERVICE_DIR: exchange-matching
        CMD_DIR: matching
    env_file:
      - ${PROD_ENV_FILE:-./prod.env}
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl -fsS http://localhost:8082/ready >/dev/null || exit 1",
        ]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 20s
    restart: unless-stopped
    stop_grace_period: 20s
    init: true
    networks: [exchange-net]

  clearing:
    image: exchange-clearing:${APP_VERSION:-latest}
    build:
      context: ../..
      dockerfile: deploy/prod/Dockerfile.go-service
      args:
        SERVICE_DIR: exchange-clearing
        CMD_DIR: clearing
    env_file:
      - ${PROD_ENV_FILE:-./prod.env}
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl -fsS http://localhost:8083/ready >/dev/null || exit 1",
        ]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 20s
    restart: unless-stopped
    stop_grace_period: 20s
    init: true
    networks: [exchange-net]

  marketdata:
    image: exchange-marketdata:${APP_VERSION:-latest}
    build:
      context: ../..
      dockerfile: deploy/prod/Dockerfile.go-service
      args:
        SERVICE_DIR: exchange-marketdata
        CMD_DIR: marketdata
    env_file:
      - ${PROD_ENV_FILE:-./prod.env}
    # If you need to expose public WS directly, uncomment this.
    # ports:
    #   - "8094:8094"
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl -fsS http://localhost:8084/ready >/dev/null || exit 1",
        ]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 20s
    restart: unless-stopped
    stop_grace_period: 20s
    init: true
    networks: [exchange-net]

  # Admin/Wallet should not be public. Put behind VPN or internal ingress.
  admin:
    image: exchange-admin:${APP_VERSION:-latest}
    build:
      context: ../..
      dockerfile: deploy/prod/Dockerfile.go-service
      args:
        SERVICE_DIR: exchange-admin
        CMD_DIR: admin
    env_file:
      - ${PROD_ENV_FILE:-./prod.env}
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl -fsS http://localhost:8087/ready >/dev/null || exit 1",
        ]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 20s
    restart: unless-stopped
    stop_grace_period: 20s
    init: true
    networks: [exchange-net]

  wallet:
    image: exchange-wallet:${APP_VERSION:-latest}
    build:
      context: ../..
      dockerfile: deploy/prod/Dockerfile.go-service
      args:
        SERVICE_DIR: exchange-wallet
        CMD_DIR: wallet
    env_file:
      - ${PROD_ENV_FILE:-./prod.env}
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl -fsS http://localhost:8086/ready >/dev/null || exit 1",
        ]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 20s
    restart: unless-stopped
    stop_grace_period: 20s
    init: true
    networks: [exchange-net]

networks:
  exchange-net:
    name: exchange-prod-net
