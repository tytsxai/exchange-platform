x-default-logging: &default-logging
  driver: json-file
  options:
    max-size: ${DOCKER_LOG_MAX_SIZE:-20m}
    max-file: ${DOCKER_LOG_MAX_FILE:-5}

services:
  prometheus:
    # Pin versions to avoid surprise upgrades from :latest.
    image: prom/prometheus:${PROMETHEUS_VERSION:-v2.50.1}
    container_name: exchange-prod-prometheus
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./alerts.yml:/etc/prometheus/alerts.yml:ro
      # Optional: if you enable METRICS_TOKEN on services, mount a token file and
      # use `bearer_token_file` in prometheus.yml.
      # - ./metrics.token:/etc/prometheus/metrics.token:ro
      - prometheus_data:/prometheus
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
    depends_on:
      - alertmanager
      - blackbox-exporter
    # Keep it internal by default; expose only if you know what you're doing.
    # ports:
    #   - "9090:9090"
    restart: unless-stopped
    logging: *default-logging
    networks: [exchange-net]

  alertmanager:
    image: prom/alertmanager:${ALERTMANAGER_VERSION:-v0.27.0}
    container_name: exchange-prod-alertmanager
    volumes:
      - ./alertmanager.yml:/etc/alertmanager/alertmanager.yml:ro
      - alertmanager_data:/alertmanager
    command:
      - "--config.file=/etc/alertmanager/alertmanager.yml"
      - "--storage.path=/alertmanager"
    # Keep it internal by default; expose only if you know what you're doing.
    # ports:
    #   - "9093:9093"
    restart: unless-stopped
    logging: *default-logging
    networks: [exchange-net]

  blackbox-exporter:
    image: prom/blackbox-exporter:${BLACKBOX_EXPORTER_VERSION:-v0.25.0}
    container_name: exchange-prod-blackbox
    volumes:
      - ./blackbox.yml:/etc/blackbox_exporter/config.yml:ro
    command:
      - "--config.file=/etc/blackbox_exporter/config.yml"
    # Keep it internal by default; expose only if you know what you're doing.
    # ports:
    #   - "9115:9115"
    restart: unless-stopped
    logging: *default-logging
    networks: [exchange-net]

  grafana:
    # Pin versions to avoid surprise upgrades from :latest.
    image: grafana/grafana:${GRAFANA_VERSION:-10.4.5}
    container_name: exchange-prod-grafana
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD:?set in deploy/prod/monitoring.env}
      GF_USERS_ALLOW_SIGN_UP: "false"
    volumes:
      - grafana_data:/var/lib/grafana
    depends_on:
      - prometheus
    # Keep it internal by default; expose only if you know what you're doing.
    # ports:
    #   - "3000:3000"
    restart: unless-stopped
    logging: *default-logging
    networks: [exchange-net]

volumes:
  prometheus_data:
  alertmanager_data:
  grafana_data:

networks:
  exchange-net:
    external: true
    name: exchange-prod-net
