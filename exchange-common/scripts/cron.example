# Example cron entries (server local time).
# Adjust paths and env vars for your deployment.
#
# Recommended: run in a dedicated "ops" host/container with least privilege.

# Daily PostgreSQL backup at 03:00 (requires DB_URL with TLS in prod)
0 3 * * * DB_URL="postgres://exchange:***@db:5432/exchange?sslmode=require" KEEP_DAYS=30 /bin/bash /opt/exchange/exchange-common/scripts/backup-db.sh >/var/log/exchange/backup-db.log 2>&1

# Daily Redis RDB backup at 03:30 (requires REDIS_ADDR + REDIS_PASSWORD; use REDIS_TLS=true for TLS)
30 3 * * * REDIS_ADDR="redis:6379" REDIS_PASSWORD="***" KEEP_DAYS=30 /bin/bash /opt/exchange/exchange-common/scripts/backup-redis.sh >/var/log/exchange/backup-redis.log 2>&1

# Daily reconciliation at 04:00 (ensure alerting on failures)
0 4 * * * /opt/exchange/exchange-clearing/bin/reconciliation >/var/log/exchange/reconciliation.log 2>&1

# Daily Redis Streams trimming (avoid unbounded growth)
30 4 * * * REDIS_ADDR="redis:6379" REDIS_PASSWORD="***" STREAMS="exchange:orders,exchange:events,exchange:events:dlq" MAX_LEN=1000000 /bin/bash /opt/exchange/exchange-common/scripts/trim-streams.sh >/var/log/exchange/trim-streams.log 2>&1

# Optional (docker compose): restart unhealthy services every minute
# * * * * * PROD_ENV_FILE=/opt/exchange/deploy/prod/prod.env /bin/bash /opt/exchange/deploy/prod/restart-unhealthy.sh >/var/log/exchange/restart-unhealthy.log 2>&1

# Weekly restore drill (stage environment only!) - manual trigger recommended
# 0 5 * * 0 /bin/bash /opt/exchange/exchange-common/scripts/restore-db.sh /backups/latest.dump
